# Makefile.toml Blindado

[config]
default_to_workspace = false
skip_core_tasks = true

# --- 1. FRONTEND (Executa nativamente no Mac) ---

[tasks.npm-install]
description = "Instala dependências do Node.js"
command = "npm"
args = ["install"]

[tasks.build-assets]
description = "Gera CSS e JS usando o script do package.json"
dependencies = ["npm-install"]
command = "npm"
args = ["run", "build"]

# --- 2. BACKEND (Rust via Cross/Cargo com ENV explícito) ---

# Linux ARM64
[tasks.build-linux-arm64]
description = "Compila para Linux ARM64 usando Docker (Cross)"
dependencies = ["build-assets"]
command = "cross"
# AQUI ESTÁ O SEGREDO: Injetamos as variáveis via ENV no comando
args = [
    "build", 
    "--release", 
    "--target", "aarch64-unknown-linux-gnu"
]
# Forçamos as variáveis aqui também para garantir
env = { "KOSHELF_SKIP_NODE_BUILD" = "true", "KOSHELF_SKIP_NPM_INSTALL" = "true" }

# Linux x86_64
[tasks.build-linux-x64]
description = "Compila para Linux Intel/AMD64 usando Docker (Cross)"
dependencies = ["build-assets"]
command = "cross"
args = [
    "build", 
    "--release", 
    "--target", "x86_64-unknown-linux-gnu"
]
env = { "KOSHELF_SKIP_NODE_BUILD" = "true", "KOSHELF_SKIP_NPM_INSTALL" = "true" }

# Windows x86_64
[tasks.build-windows]
description = "Compila para Windows usando Docker (Cross)"
dependencies = ["build-assets"]
command = "cross"
args = [
    "build", 
    "--release", 
    "--target", "x86_64-pc-windows-gnu"
]
env = { "KOSHELF_SKIP_NODE_BUILD" = "true", "KOSHELF_SKIP_NPM_INSTALL" = "true" }

# macOS ARM64 (Nativo)
[tasks.build-mac]
description = "Compila para macOS (Apple Silicon) nativamente"
dependencies = ["build-assets"]
command = "cargo"
args = ["build", "--release"]
# No Mac não precisamos pular, mas ajuda a ser mais rápido se já rodou antes
env = { "KOSHELF_SKIP_NODE_BUILD" = "true", "KOSHELF_SKIP_NPM_INSTALL" = "true" }

# --- 3. EMPACOTAMENTO ---

[tasks.create-release-dir]
script = ["mkdir -p release"]

[tasks.pack-linux-arm64]
dependencies = ["create-release-dir", "build-linux-arm64"]
script = '''
cp target/aarch64-unknown-linux-gnu/release/koshelf release/koshelf-linux-arm64
tar -czf release/koshelf-linux-arm64.tar.gz -C release koshelf-linux-arm64
rm release/koshelf-linux-arm64
'''

[tasks.pack-linux-x64]
dependencies = ["create-release-dir", "build-linux-x64"]
script = '''
cp target/x86_64-unknown-linux-gnu/release/koshelf release/koshelf-linux-x64
tar -czf release/koshelf-linux-x64.tar.gz -C release koshelf-linux-x64
rm release/koshelf-linux-x64
'''

[tasks.pack-windows]
dependencies = ["create-release-dir", "build-windows"]
script = '''
cp target/x86_64-pc-windows-gnu/release/koshelf.exe release/koshelf-windows.exe
zip -j release/koshelf-windows.zip release/koshelf-windows.exe || echo "Aviso: zip não instalado"
rm release/koshelf-windows.exe
'''

[tasks.pack-mac]
dependencies = ["create-release-dir", "build-mac"]
script = '''
cp target/release/koshelf release/koshelf-mac
tar -czf release/koshelf-mac.tar.gz -C release koshelf-mac
rm release/koshelf-mac
'''

# --- 4. TAREFA PRINCIPAL ---

[tasks.release-all]
description = "Gera releases para todas as plataformas na pasta release/"
dependencies = [
    "pack-linux-arm64",
    "pack-linux-x64",
    "pack-windows",
    "pack-mac"
]