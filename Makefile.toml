# Makefile.toml - Local Full Automation

[config]
default_to_workspace = false
skip_core_tasks = true

# --- 1. FRONTEND ---
[tasks.npm-install]
command = "npm"
args = ["install"]

[tasks.build-assets]
dependencies = ["npm-install"]
command = "npm"
args = ["run", "build"]

# --- 2. BACKEND BUILDS ---
[tasks.build-linux-arm64]
dependencies = ["build-assets"]
command = "cross"
args = ["build", "--release", "--target", "aarch64-unknown-linux-gnu"]
env = { "KOSHELF_SKIP_NODE_BUILD" = "true", "KOSHELF_SKIP_NPM_INSTALL" = "true" }

[tasks.build-linux-x64]
dependencies = ["build-assets"]
command = "cross"
args = ["build", "--release", "--target", "x86_64-unknown-linux-gnu"]
env = { "KOSHELF_SKIP_NODE_BUILD" = "true", "KOSHELF_SKIP_NPM_INSTALL" = "true" }

[tasks.build-windows]
dependencies = ["build-assets"]
command = "cross"
args = ["build", "--release", "--target", "x86_64-pc-windows-gnu"]
env = { "KOSHELF_SKIP_NODE_BUILD" = "true", "KOSHELF_SKIP_NPM_INSTALL" = "true" }

[tasks.build-mac]
dependencies = ["build-assets"]
command = "cargo"
args = ["build", "--release"]
env = { "KOSHELF_SKIP_NODE_BUILD" = "true", "KOSHELF_SKIP_NPM_INSTALL" = "true" }

# --- 3. DOCKER AUTOMATION (Local) ---
[tasks.docker-build]
description = "Build the Docker image locally using the Dockerfile"
dependencies = ["build-assets"]
command = "docker"
args = ["build", "-t", "koshelf:latest", "."]

# --- 4. PACKAGING ---
[tasks.create-release-dir]
script = ["mkdir -p release"]

[tasks.pack-linux-arm64]
dependencies = ["create-release-dir", "build-linux-arm64"]
script = '''
cp target/aarch64-unknown-linux-gnu/release/koshelf release/koshelf-linux-arm64
tar -czf release/koshelf-linux-arm64.tar.gz -C release koshelf-linux-arm64
rm release/koshelf-linux-arm64
'''

[tasks.pack-linux-x64]
dependencies = ["create-release-dir", "build-linux-x64"]
script = '''
cp target/x86_64-unknown-linux-gnu/release/koshelf release/koshelf-linux-x64
tar -czf release/koshelf-linux-x64.tar.gz -C release koshelf-linux-x64
rm release/koshelf-linux-x64
'''

[tasks.pack-windows]
dependencies = ["create-release-dir", "build-windows"]
script = '''
cp target/x86_64-pc-windows-gnu/release/koshelf.exe release/koshelf-windows.exe
zip -j release/koshelf-windows.zip release/koshelf-windows.exe || echo "Warning: zip not installed"
rm release/koshelf-windows.exe
'''

[tasks.pack-dmg]
description = "Create macOS .app bundle and generate .dmg installer"
dependencies = ["create-release-dir", "build-mac"]
script = '''
# Garante que o script de build use os caminhos novos
bash scripts/build_macos_app.sh

# Remove o DMG antigo
rm -f release/KoShelf-Installer.dmg

# Cria o DMG profissional
create-dmg \
  --volname "KoShelf Installer" \
  --window-pos 200 120 \
  --window-size 800 400 \
  --icon-size 100 \
  --icon "KoShelf.app" 200 190 \
  --hide-extension "KoShelf.app" \
  --app-drop-link 600 185 \
  "release/KoShelf-Installer.dmg" \
  "release/KoShelf.app"
'''

# --- 5. THE MASTER TASK ---
[tasks.release-all]
description = "Gera todos os pacotes e a imagem Docker"
dependencies = [
    "pack-linux-arm64",
    "pack-linux-x64",
    "pack-windows",
    "pack-dmg",
    "docker-build"
]

# --- 6. GITHUB & DOCKER PUSH ---

[tasks.docker-push]
description = "Tag and push the Docker image to GHCR"
command = "bash"
args = ["-c", "docker tag koshelf:latest ghcr.io/zanivann/koshelf:latest && docker push ghcr.io/zanivann/koshelf:latest"]

[tasks.git-deploy]
description = "Commit and push changes to GitHub"
script = '''
git add .
git commit -m "${COMMIT_MSG}"
git push origin main
'''

[tasks.gh-release]
description = "Create a new release on GitHub using the CLI"
script = '''
gh release create ${RELEASE_VERSION} release/* --title "Release ${RELEASE_VERSION}" --notes "${COMMIT_MSG}"
'''