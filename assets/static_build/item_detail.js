var S=class{constructor(t){this.value=t}valueOf(){return this.value}},l=class extends S{constructor(t="???"){super(t)}toString(t){return`{${this.value}}`}},d=class extends S{constructor(t,e={}){super(t),this.opts=e}toString(t){try{return t.memoizeIntlObject(Intl.NumberFormat,this.opts).format(this.value)}catch(e){return t.reportError(e),this.value.toString(10)}}},g=class extends S{constructor(t,e={}){super(t),this.opts=e}toString(t){try{return t.memoizeIntlObject(Intl.DateTimeFormat,this.opts).format(this.value)}catch(e){return t.reportError(e),new Date(this.value).toISOString()}}};var z=100,dt="\u2068",Et="\u2069";function ht(r,t,e){if(e===t||e instanceof d&&t instanceof d&&e.value===t.value)return!0;if(t instanceof d&&typeof e=="string"){let n=r.memoizeIntlObject(Intl.PluralRules,t.opts).select(t.value);if(e===n)return!0}return!1}function H(r,t,e){return t[e]?_(r,t[e].value):(r.reportError(new RangeError("No default")),new l)}function D(r,t){let e=[],n=Object.create(null);for(let i of t)i.type==="narg"?n[i.name]=b(r,i.value):e.push(b(r,i));return{positional:e,named:n}}function b(r,t){switch(t.type){case"str":return t.value;case"num":return new d(t.value,{minimumFractionDigits:t.precision});case"var":return gt(r,t);case"mesg":return St(r,t);case"term":return pt(r,t);case"func":return mt(r,t);case"select":return yt(r,t);default:return new l}}function gt(r,{name:t}){let e;if(r.params)if(Object.prototype.hasOwnProperty.call(r.params,t))e=r.params[t];else return new l(`$${t}`);else if(r.args&&Object.prototype.hasOwnProperty.call(r.args,t))e=r.args[t];else return r.reportError(new ReferenceError(`Unknown variable: $${t}`)),new l(`$${t}`);if(e instanceof S)return e;switch(typeof e){case"string":return e;case"number":return new d(e);case"object":if(e instanceof Date)return new g(e.getTime());default:return r.reportError(new TypeError(`Variable type not supported: $${t}, ${typeof e}`)),new l(`$${t}`)}}function St(r,{name:t,attr:e}){let n=r.bundle._messages.get(t);if(!n)return r.reportError(new ReferenceError(`Unknown message: ${t}`)),new l(t);if(e){let i=n.attributes[e];return i?_(r,i):(r.reportError(new ReferenceError(`Unknown attribute: ${e}`)),new l(`${t}.${e}`))}return n.value?_(r,n.value):(r.reportError(new ReferenceError(`No value: ${t}`)),new l(t))}function pt(r,{name:t,attr:e,args:n}){let i=`-${t}`,o=r.bundle._terms.get(i);if(!o)return r.reportError(new ReferenceError(`Unknown term: ${i}`)),new l(i);if(e){let c=o.attributes[e];if(c){r.params=D(r,n).named;let m=_(r,c);return r.params=null,m}return r.reportError(new ReferenceError(`Unknown attribute: ${e}`)),new l(`${i}.${e}`)}r.params=D(r,n).named;let f=_(r,o.value);return r.params=null,f}function mt(r,{name:t,args:e}){let n=r.bundle._functions[t];if(!n)return r.reportError(new ReferenceError(`Unknown function: ${t}()`)),new l(`${t}()`);if(typeof n!="function")return r.reportError(new TypeError(`Function ${t}() is not callable`)),new l(`${t}()`);try{let i=D(r,e);return n(i.positional,i.named)}catch(i){return r.reportError(i),new l(`${t}()`)}}function yt(r,{selector:t,variants:e,star:n}){let i=b(r,t);if(i instanceof l)return H(r,e,n);for(let o of e){let f=b(r,o.key);if(ht(r,i,f))return _(r,o.value)}return H(r,e,n)}function K(r,t){if(r.dirty.has(t))return r.reportError(new RangeError("Cyclic reference")),new l;r.dirty.add(t);let e=[],n=r.bundle._useIsolating&&t.length>1;for(let i of t){if(typeof i=="string"){e.push(r.bundle._transform(i));continue}if(r.placeables++,r.placeables>z)throw r.dirty.delete(t),new RangeError(`Too many placeables expanded: ${r.placeables}, max allowed is ${z}`);n&&e.push(dt),e.push(b(r,i).toString(r)),n&&e.push(Et)}return r.dirty.delete(t),e.join("")}function _(r,t){return typeof t=="string"?r.bundle._transform(t):K(r,t)}var O=class{constructor(t,e,n){this.dirty=new WeakSet,this.params=null,this.placeables=0,this.bundle=t,this.errors=e,this.args=n}reportError(t){if(!this.errors||!(t instanceof Error))throw t;this.errors.push(t)}memoizeIntlObject(t,e){let n=this.bundle._intls.get(t);n||(n={},this.bundle._intls.set(t,n));let i=JSON.stringify(e);return n[i]||(n[i]=new t(this.bundle.locales,e)),n[i]}};function R(r,t){let e=Object.create(null);for(let[n,i]of Object.entries(r))t.includes(n)&&(e[n]=i.valueOf());return e}var G=["unitDisplay","currencyDisplay","useGrouping","minimumIntegerDigits","minimumFractionDigits","maximumFractionDigits","minimumSignificantDigits","maximumSignificantDigits"];function q(r,t){let e=r[0];if(e instanceof l)return new l(`NUMBER(${e.valueOf()})`);if(e instanceof d)return new d(e.valueOf(),{...e.opts,...R(t,G)});if(e instanceof g)return new d(e.valueOf(),{...R(t,G)});throw new TypeError("Invalid argument to NUMBER")}var Z=["dateStyle","timeStyle","fractionalSecondDigits","dayPeriod","hour12","weekday","era","year","month","day","hour","minute","second","timeZoneName"];function W(r,t){let e=r[0];if(e instanceof l)return new l(`DATETIME(${e.valueOf()})`);if(e instanceof g)return new g(e.valueOf(),{...e.opts,...R(t,Z)});if(e instanceof d)return new g(e.valueOf(),{...R(t,Z)});throw new TypeError("Invalid argument to DATETIME")}var X=new Map;function J(r){let t=Array.isArray(r)?r.join(" "):r,e=X.get(t);return e===void 0&&(e=new Map,X.set(t,e)),e}var w=class{constructor(t,{functions:e,useIsolating:n=!0,transform:i=o=>o}={}){this._terms=new Map,this._messages=new Map,this.locales=Array.isArray(t)?t:[t],this._functions={NUMBER:q,DATETIME:W,...e},this._useIsolating=n,this._transform=i,this._intls=J(t)}hasMessage(t){return this._messages.has(t)}getMessage(t){return this._messages.get(t)}addResource(t,{allowOverrides:e=!1}={}){let n=[];for(let i=0;i<t.body.length;i++){let o=t.body[i];if(o.id.startsWith("-")){if(e===!1&&this._terms.has(o.id)){n.push(new Error(`Attempt to override an existing term: "${o.id}"`));continue}this._terms.set(o.id,o)}else{if(e===!1&&this._messages.has(o.id)){n.push(new Error(`Attempt to override an existing message: "${o.id}"`));continue}this._messages.set(o.id,o)}}return n}formatPattern(t,e=null,n=null){if(typeof t=="string")return this._transform(t);let i=new O(this,n,e);try{return K(i,t).toString(i)}catch(o){if(i.errors&&o instanceof Error)return i.errors.push(o),new l().toString(i);throw o}}};var P=/^(-?[a-zA-Z][\w-]*) *= */gm,Q=/\.([a-zA-Z][\w-]*) *= */y,_t=/\*?\[/y,$=/(-?[0-9]+(?:\.([0-9]+))?)/y,wt=/([a-zA-Z][\w-]*)/y,tt=/([$-])?([a-zA-Z][\w-]*)(?:\.([a-zA-Z][\w-]*))?/y,Tt=/^[A-Z][A-Z0-9_-]*$/,A=/([^{}\n\r]+)/y,vt=/([^\\"\n\r]*)/y,et=/\\([\\"])/y,rt=/\\u([a-fA-F0-9]{4})|\\U([a-fA-F0-9]{6})/y,bt=/^\n+/,nt=/ +$/,It=/ *\r?\n/g,Ot=/( *)$/,Rt=/{\s*/y,st=/\s*}/y,At=/\[\s*/y,xt=/\s*] */y,Lt=/\s*\(\s*/y,Nt=/\s*->\s*/y,Mt=/\s*:\s*/y,Ct=/\s*,?\s*/y,Dt=/\s+/y,I=class{constructor(t){this.body=[],P.lastIndex=0;let e=0;for(;;){let s=P.exec(t);if(s===null)break;e=P.lastIndex;try{this.body.push(m(s[1]))}catch(a){if(a instanceof SyntaxError)continue;throw a}}function n(s){return s.lastIndex=e,s.test(t)}function i(s,a){if(t[e]===s)return e++,!0;if(a)throw new a(`Expected ${s}`);return!1}function o(s,a){if(n(s))return e=s.lastIndex,!0;if(a)throw new a(`Expected ${s.toString()}`);return!1}function f(s){s.lastIndex=e;let a=s.exec(t);if(a===null)throw new SyntaxError(`Expected ${s.toString()}`);return e=s.lastIndex,a}function c(s){return f(s)[1]}function m(s){let a=N(),u=it();if(a===null&&Object.keys(u).length===0)throw new SyntaxError("Expected message value or attributes");return{id:s,value:a,attributes:u}}function it(){let s=Object.create(null);for(;n(Q);){let a=c(Q),u=N();if(u===null)throw new SyntaxError("Expected attribute value");s[a]=u}return s}function N(){let s;if(n(A)&&(s=c(A)),t[e]==="{"||t[e]==="}")return M(s?[s]:[],1/0);let a=j();return a?s?M([s,a],a.length):(a.value=C(a.value,bt),M([a],a.length)):s?C(s,nt):null}function M(s=[],a){for(;;){if(n(A)){s.push(c(A));continue}if(t[e]==="{"){s.push(B());continue}if(t[e]==="}")throw new SyntaxError("Unbalanced closing brace");let h=j();if(h){s.push(h),a=Math.min(a,h.length);continue}break}let u=s.length-1,y=s[u];typeof y=="string"&&(s[u]=C(y,nt));let v=[];for(let h of s)h instanceof x&&(h=h.value.slice(0,h.value.length-a)),h&&v.push(h);return v}function B(){o(Rt,SyntaxError);let s=U();if(o(st))return s;if(o(Nt)){let a=lt();return o(st,SyntaxError),{type:"select",selector:s,...a}}throw new SyntaxError("Unclosed placeable")}function U(){if(t[e]==="{")return B();if(n(tt)){let[,s,a,u=null]=f(tt);if(s==="$")return{type:"var",name:a};if(o(Lt)){let y=ot();if(s==="-")return{type:"term",name:a,attr:u,args:y};if(Tt.test(a))return{type:"func",name:a,args:y};throw new SyntaxError("Function names must be all upper-case")}return s==="-"?{type:"term",name:a,attr:u,args:[]}:{type:"mesg",name:a,attr:u}}return k()}function ot(){let s=[];for(;;){switch(t[e]){case")":return e++,s;case void 0:throw new SyntaxError("Unclosed argument list")}s.push(at()),o(Ct)}}function at(){let s=U();return s.type!=="mesg"?s:o(Mt)?{type:"narg",name:s.name,value:k()}:s}function lt(){let s=[],a=0,u;for(;n(_t);){i("*")&&(u=a);let y=ut(),v=N();if(v===null)throw new SyntaxError("Expected variant value");s[a++]={key:y,value:v}}if(a===0)return null;if(u===void 0)throw new SyntaxError("Expected default variant");return{variants:s,star:u}}function ut(){o(At,SyntaxError);let s;return n($)?s=Y():s={type:"str",value:c(wt)},o(xt,SyntaxError),s}function k(){if(n($))return Y();if(t[e]==='"')return ct();throw new SyntaxError("Invalid expression")}function Y(){let[,s,a=""]=f($),u=a.length;return{type:"num",value:parseFloat(s),precision:u}}function ct(){i('"',SyntaxError);let s="";for(;;){if(s+=c(vt),t[e]==="\\"){s+=ft();continue}if(i('"'))return{type:"str",value:s};throw new SyntaxError("Unclosed string literal")}}function ft(){if(n(et))return c(et);if(n(rt)){let[,s,a]=f(rt),u=parseInt(s||a,16);return u<=55295||57344<=u?String.fromCodePoint(u):"\uFFFD"}throw new SyntaxError("Unknown escape sequence")}function j(){let s=e;switch(o(Dt),t[e]){case".":case"[":case"*":case"}":case void 0:return!1;case"{":return V(t.slice(s,e))}return t[e-1]===" "?V(t.slice(s,e)):!1}function C(s,a){return s.replace(a,"")}function V(s){let a=s.replace(It,`
`),u=Ot.exec(s)[1].length;return new x(a,u)}}},x=class{constructor(t,e){this.value=t,this.length=e}};var p=null,F=null;async function Kt(){if(!p)try{let t=await(await fetch(`/assets/json/locales.json?t=${Date.now()}`)).json();p=new w(t.language);for(let e of t.resources){let n=new I(e);p.addResource(n)}}catch(r){console.warn("Failed to load translations:",r),p=new w("en-US")}}var T={async init(){F||(F=Kt()),await F},get(r,t){if(!p)return r;let e;typeof t=="number"?e={count:t}:e=t;let n=r,i,o=r.indexOf(".");o!==-1&&(n=r.substring(0,o),i=r.substring(o+1));let f=p.getMessage(n);if(!f)return r;let c;return i?c=f.attributes?.[i]:c=f.value,c?p.formatPattern(c,e):r},getLanguage(){return p?.locales[0]||"en-US"}};var E=class{static get(t,e=null){try{let n=localStorage.getItem(this.PREFIX+t);return n===null?e:JSON.parse(n)}catch(n){return console.warn("StorageManager: Failed to parse item",n),e}}static set(t,e){try{localStorage.setItem(this.PREFIX+t,JSON.stringify(e))}catch(n){console.warn("StorageManager: Failed to save item",n)}}static remove(t){localStorage.removeItem(this.PREFIX+t)}};E.PREFIX="koshelf_",E.KEYS={RECAP_FILTER:"recap_filter",STATS_FILTER:"stats_filter",LIBRARY_LIST_BOOKS_FILTER:"library_list_books_filter",LIBRARY_LIST_COMICS_FILTER:"library_list_comics_filter",LIBRARY_LIST_BOOKS_SECTIONS:"library_list_books_sections",LIBRARY_LIST_COMICS_SECTIONS:"library_list_comics_sections",ITEM_DETAIL_BOOKS_SECTIONS:"item_detail_books_sections",ITEM_DETAIL_COMICS_SECTIONS:"item_detail_comics_sections",STATS_ALL_SECTIONS:"stats_all_sections",STATS_BOOKS_SECTIONS:"stats_books_sections",STATS_COMICS_SECTIONS:"stats_comics_sections",RECAP_SORT_NEWEST:"recap_sort_newest",VERSION:"version",SERVER_MODE:"server_mode",RELOAD_COUNT:"reload_count",LAST_RELOAD:"last_reload"};var L=class{constructor(){this.sections=new Map;this.persistenceKey=null;this.persistedState=null;this.init()}async init(){await T.init(),this.persistenceKey=this.resolvePersistenceKey(),this.persistedState=this.persistenceKey?E.get(this.persistenceKey,{})??{}:null,document.querySelectorAll("section[data-name]").forEach(e=>{let n=e.dataset.name;if(!n)return;let i=e.dataset.defaultVisible==="true",o=e.querySelector("button"),f=e.querySelector('[id$="Container"]'),c=o?.querySelector("svg"),m=o?.querySelector("span");o&&f&&c&&m&&(this.sections.set(n,{section:e,button:o,container:f,chevron:c,buttonText:m,defaultVisible:i}),this.setInitialState(n),o.addEventListener("click",()=>{this.toggle(n,{persist:!0})}))})}resolvePersistenceKey(){let t=document.body?.dataset.sectionToggleScope,e=document.body?.dataset.sectionToggleKind;return t==="library-list"?e==="comics"?E.KEYS.LIBRARY_LIST_COMICS_SECTIONS:e==="books"?E.KEYS.LIBRARY_LIST_BOOKS_SECTIONS:null:t==="item-details"?e==="comics"?E.KEYS.ITEM_DETAIL_COMICS_SECTIONS:e==="books"?E.KEYS.ITEM_DETAIL_BOOKS_SECTIONS:null:t==="statistics"?e==="books"?E.KEYS.STATS_BOOKS_SECTIONS:e==="comics"?E.KEYS.STATS_COMICS_SECTIONS:e==="all"?E.KEYS.STATS_ALL_SECTIONS:null:null}savePersistedState(){!this.persistenceKey||!this.persistedState||E.set(this.persistenceKey,this.persistedState)}setInitialState(t){let e=this.sections.get(t);if(!e)return;let{container:n,chevron:i,buttonText:o,defaultVisible:f}=e,c=this.persistedState&&Object.prototype.hasOwnProperty.call(this.persistedState,t)?this.persistedState[t]:null;(c===null?f:c)?(n.classList.remove("hidden"),i.style.transform="rotate(0deg)",o.textContent=T.get("toggle.hide")):(n.classList.add("hidden"),i.style.transform="rotate(-90deg)",o.textContent=T.get("toggle.show"))}toggle(t,e={}){let n=this.sections.get(t);if(!n)return;let{container:i}=n;i.classList.contains("hidden")?this.show(t,e):this.hide(t,e)}show(t,e={}){let n=this.sections.get(t);if(!n)return;let{container:i,chevron:o,buttonText:f}=n;i.classList.remove("hidden"),o.style.transform="rotate(0deg)",f.textContent=T.get("toggle.hide"),(e.persist??!0)&&this.persistedState&&(this.persistedState[t]=!0,this.savePersistedState())}hide(t,e={}){let n=this.sections.get(t);if(!n)return;let{container:i,chevron:o,buttonText:f}=n;i.classList.add("hidden"),o.style.transform="rotate(-90deg)",f.textContent=T.get("toggle.show"),(e.persist??!0)&&this.persistedState&&(this.persistedState[t]=!1,this.savePersistedState())}isVisible(t){let e=this.sections.get(t);return e?!e.container.classList.contains("hidden"):!1}showAll(){this.sections.forEach((t,e)=>{this.show(e)})}hideAll(){this.sections.forEach((t,e)=>{this.hide(e)})}getSectionNames(){return Array.from(this.sections.keys())}restorePersistedOrDefault(){this.sections.forEach((t,e)=>{let n=this.persistedState&&Object.prototype.hasOwnProperty.call(this.persistedState,e)?this.persistedState[e]:null;(n===null?t.defaultVisible:n)?this.show(e,{persist:!1}):this.hide(e,{persist:!1})})}};document.addEventListener("DOMContentLoaded",()=>{new L;let r=document.getElementById("shareDropdownButton"),t=document.getElementById("shareDropdownMenu");r?.addEventListener("click",()=>{t?.classList.toggle("hidden")})});
