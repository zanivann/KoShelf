var i=class{static get(t,o=null){try{let r=localStorage.getItem(this.PREFIX+t);return r===null?o:JSON.parse(r)}catch(r){return console.warn("StorageManager: Failed to parse item",r),o}}static set(t,o){try{localStorage.setItem(this.PREFIX+t,JSON.stringify(o))}catch(r){console.warn("StorageManager: Failed to save item",r)}}static remove(t){localStorage.removeItem(this.PREFIX+t)}};i.PREFIX="koshelf_",i.KEYS={RECAP_FILTER:"recap_filter",STATS_FILTER:"stats_filter",LIBRARY_LIST_BOOKS_FILTER:"library_list_books_filter",LIBRARY_LIST_COMICS_FILTER:"library_list_comics_filter",LIBRARY_LIST_BOOKS_SECTIONS:"library_list_books_sections",LIBRARY_LIST_COMICS_SECTIONS:"library_list_comics_sections",ITEM_DETAIL_BOOKS_SECTIONS:"item_detail_books_sections",ITEM_DETAIL_COMICS_SECTIONS:"item_detail_comics_sections",STATS_ALL_SECTIONS:"stats_all_sections",STATS_BOOKS_SECTIONS:"stats_books_sections",STATS_COMICS_SECTIONS:"stats_comics_sections",RECAP_SORT_NEWEST:"recap_sort_newest",VERSION:"version",SERVER_MODE:"server_mode",RELOAD_COUNT:"reload_count",LAST_RELOAD:"last_reload"};var c=i.KEYS,E={maxRetries:3,cooldownMs:6e4},A=5e3,T=1e4,L="{{SERVER_MODE}}",d=i.get(c.VERSION),S=null;"serviceWorker"in navigator&&I();function g(e,t){if(e===null)return t;let o=Number.parseInt(e,10);return Number.isFinite(o)?o:t}async function I(){try{await navigator.serviceWorker.register("/service-worker.js")}catch(e){console.error("[PWA] Service Worker registration failed:",e),u()}navigator.serviceWorker.addEventListener("message",O),window.addEventListener("error",k),window.addEventListener("unhandledrejection",C),setTimeout(W,1e3)}function O({data:e}){e?.type==="CACHE_UPDATED"?v():e?.type==="CRITICAL_ERROR"&&(console.error("[PWA] Service Worker critical error:",e.error),u())}function k(e){(e.error||e.message)&&(console.error("[PWA] Window error detected:",e.error||e.message),u())}function C(e){e.reason?console.error("[PWA] Unhandled rejection detected:",e.reason):console.error("[PWA] Unhandled rejection detected"),u()}function u(){let e=Date.now(),t=g(i.get(c.LAST_RELOAD),0),o=g(i.get(c.RELOAD_COUNT),0);if(e-t>E.cooldownMs&&(o=0),o>=E.maxRetries){console.error("[PWA] Recovery limit reached, stopping auto-reload");return}i.set(c.RELOAD_COUNT,String(o+1)),i.set(c.LAST_RELOAD,String(e)),console.log("[PWA] Attempting recovery reload..."),navigator.serviceWorker.getRegistrations().then(r=>r.forEach(n=>n.unregister())).then(()=>location.reload())}async function W(){let e=await f();e&&p(e),L==="internal"?b():N()}async function f(){try{let e=await fetch("/version.txt",{cache:"no-store"});return e.ok?(await e.text()).trim():null}catch{return null}}function p(e){if(console.log(`[PWA] Version check: stored=${d}, fetched=${e}, lastNotified=${S}`),d===null){d=e,i.set(c.VERSION,e),console.log("[PWA] First load, storing initial version");return}d!==e&&S!==e&&(console.log("[PWA] Version changed! Requesting cache update..."),S=e,i.set(c.VERSION,e),P())}function P(){navigator.serviceWorker.controller?(console.log("[PWA] Sending CHECK_FOR_UPDATES to service worker"),navigator.serviceWorker.controller.postMessage({type:"CHECK_FOR_UPDATES"})):(console.log("[PWA] No SW controller, showing notification directly"),v())}async function b(){for(;;)try{let e=await fetch("/api/events/version",{cache:"no-store"});e.status===200&&p((await e.text()).trim())}catch{await M()}}async function M(){for(;;){await D(A);let e=await f();if(e){p(e);return}}}function N(){setInterval(async()=>{let e=await f();e&&p(e)},T)}function v(){document.body.classList.add("update-available")}function D(e){return new Promise(t=>setTimeout(t,e))}document.addEventListener("click",e=>{let t=e.target instanceof Node?e.target:null;if(!t)return;document.querySelectorAll("details[open]").forEach(n=>{n.contains(t)||n.removeAttribute("open")}),document.querySelectorAll(".dropdown-menu, .dropdown-menu-right").forEach(n=>{n.closest("details")||n.classList.contains("hidden")||n.parentElement&&!n.parentElement.contains(t)&&n.classList.add("hidden")})});function Y(){let e=window.location.pathname,t=e.match(/^\/statistics\/(books|comics)?/);if(t)return{type:"statistics",scope:t[1]||"all"};let o=e.match(/^\/recap\/(\d{4})\/(books|comics)?/);if(o){let r=o[1];return{type:"recap",scope:o[2]||"all",year:r}}return{type:null,scope:"all"}}function F(){let e=Y();e.type==="statistics"?i.set(i.KEYS.STATS_FILTER,e.scope):e.type==="recap"&&i.set(i.KEYS.RECAP_FILTER,e.scope)}function m(e,t){return t==="all"?e:(e.endsWith("/")?e:e+"/")+t+"/"}function K(){let e=document.querySelectorAll("#nav-statistics"),t=document.querySelectorAll("#nav-recap");e.forEach(o=>{o.addEventListener("click",r=>{let n=i.get(i.KEYS.STATS_FILTER);if(n&&n!=="all"){r.preventDefault();let s=m(o.href,n);window.location.href=s}})}),t.forEach(o=>{o.addEventListener("click",r=>{let n=i.get(i.KEYS.RECAP_FILTER);if(n&&n!=="all"){r.preventDefault();let s=m(o.href,n);window.location.href=s}})})}document.addEventListener("DOMContentLoaded",()=>{F(),K()});function B(){let e=navigator.userAgent,t=/AppleWebKit/i.test(e),o=/iP(hone|ad|od)/i.test(e),r=/Macintosh/i.test(e)&&/Safari/i.test(e)&&!/Chrome|CriOS|Edg|OPR|Firefox/i.test(e);return t&&(o||r)}function _(e){return e<640?"xs":e<768?"sm":e<1024?"md":e<1280?"lg":e<1536?"xl":"2xl"}var w=!1;function h(){if(!B()||w)return;w=!0,console.debug("[KoShelf] WebKit repaint hack active");let e=_(window.innerWidth),t=!1,o=()=>{if(window.scrollY!==0)return;let n=_(window.innerWidth);if(n===e)return;e=n;let s=document.documentElement,l=document.body,R=s.style.overflowY,y=l.style.overflowY,a=s.scrollHeight<=window.innerHeight+1?document.createElement("div"):null;a&&(a.setAttribute("data-safari-repaint-spacer","true"),a.style.height="2px",a.style.width="1px",a.style.pointerEvents="none",l.appendChild(a)),s.style.overflowY="scroll",l.style.overflowY="scroll",requestAnimationFrame(()=>{window.scrollY===0&&window.scrollBy(0,1),requestAnimationFrame(()=>{window.scrollY===1&&window.scrollTo(0,0),a?.remove(),s.style.overflowY=R,l.style.overflowY=y})})},r=()=>{t||(t=!0,requestAnimationFrame(()=>{t=!1,o()}))};window.addEventListener("resize",r,{passive:!0}),window.addEventListener("orientationchange",r,{passive:!0}),window.addEventListener("pageshow",r,{passive:!0}),window.visualViewport?.addEventListener("resize",r,{passive:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>h()):h();
