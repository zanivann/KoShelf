var i=class{static get(o,t=null){try{let r=localStorage.getItem(this.PREFIX+o);return r===null?t:JSON.parse(r)}catch(r){return console.warn("StorageManager: Failed to parse item",r),t}}static set(o,t){try{localStorage.setItem(this.PREFIX+o,JSON.stringify(t))}catch(r){console.warn("StorageManager: Failed to save item",r)}}static remove(o){localStorage.removeItem(this.PREFIX+o)}};i.PREFIX="koshelf_",i.KEYS={RECAP_FILTER:"recap_filter",STATS_FILTER:"stats_filter",LIBRARY_LIST_BOOKS_FILTER:"library_list_books_filter",LIBRARY_LIST_COMICS_FILTER:"library_list_comics_filter",LIBRARY_LIST_BOOKS_SECTIONS:"library_list_books_sections",LIBRARY_LIST_COMICS_SECTIONS:"library_list_comics_sections",ITEM_DETAIL_BOOKS_SECTIONS:"item_detail_books_sections",ITEM_DETAIL_COMICS_SECTIONS:"item_detail_comics_sections",STATS_ALL_SECTIONS:"stats_all_sections",STATS_BOOKS_SECTIONS:"stats_books_sections",STATS_COMICS_SECTIONS:"stats_comics_sections",RECAP_SORT_NEWEST:"recap_sort_newest",VERSION:"version",SERVER_MODE:"server_mode",RELOAD_COUNT:"reload_count",LAST_RELOAD:"last_reload"};var u=i.KEYS,_={maxRetries:3,cooldownMs:6e4},I=5e3,C=1e4,b="{{SERVER_MODE}}",p=i.get(u.VERSION),v=null;"serviceWorker"in navigator&&W();function y(e,o){if(e===null)return o;let t=Number.parseInt(e,10);return Number.isFinite(t)?t:o}async function W(){try{await navigator.serviceWorker.register("/service-worker.js")}catch(e){console.error("[PWA] Service Worker registration failed:",e),f()}navigator.serviceWorker.addEventListener("message",P),window.addEventListener("error",M),window.addEventListener("unhandledrejection",N),setTimeout(D,1e3)}function P({data:e}){e?.type==="CACHE_UPDATED"?L():e?.type==="CRITICAL_ERROR"&&(console.error("[PWA] Service Worker critical error:",e.error),f())}function M(e){(e.error||e.message)&&(console.error("[PWA] Window error detected:",e.error||e.message),f())}function N(e){e.reason?console.error("[PWA] Unhandled rejection detected:",e.reason):console.error("[PWA] Unhandled rejection detected"),f()}function f(){let e=Date.now(),o=y(i.get(u.LAST_RELOAD),0),t=y(i.get(u.RELOAD_COUNT),0);if(e-o>_.cooldownMs&&(t=0),t>=_.maxRetries){console.error("[PWA] Recovery limit reached, stopping auto-reload");return}i.set(u.RELOAD_COUNT,String(t+1)),i.set(u.LAST_RELOAD,String(e)),console.log("[PWA] Attempting recovery reload..."),navigator.serviceWorker.getRegistrations().then(r=>r.forEach(n=>n.unregister())).then(()=>location.reload())}async function D(){let e=await w();e&&S(e),b==="internal"?Y():x()}async function w(){try{let e=await fetch("/version.txt",{cache:"no-store"});return e.ok?(await e.text()).trim():null}catch{return null}}function S(e){if(console.log(`[PWA] Version check: stored=${p}, fetched=${e}, lastNotified=${v}`),p===null){p=e,i.set(u.VERSION,e),console.log("[PWA] First load, storing initial version");return}p!==e&&v!==e&&(console.log("[PWA] Version changed! Requesting cache update..."),v=e,i.set(u.VERSION,e),F())}function F(){navigator.serviceWorker.controller?(console.log("[PWA] Sending CHECK_FOR_UPDATES to service worker"),navigator.serviceWorker.controller.postMessage({type:"CHECK_FOR_UPDATES"})):(console.log("[PWA] No SW controller, showing notification directly"),L())}async function Y(){for(;;)try{let e=await fetch("/api/events/version",{cache:"no-store"});e.status===200&&S((await e.text()).trim())}catch{await K()}}async function K(){for(;;){await B(I);let e=await w();if(e){S(e);return}}}function x(){setInterval(async()=>{let e=await w();e&&S(e)},C)}function L(){document.body.classList.add("update-available")}function B(e){return new Promise(o=>setTimeout(o,e))}document.addEventListener("click",e=>{let o=e.target instanceof Node?e.target:null;if(!o)return;document.querySelectorAll("details[open]").forEach(n=>{n.contains(o)||n.removeAttribute("open")}),document.querySelectorAll(".dropdown-menu, .dropdown-menu-right").forEach(n=>{n.closest("details")||n.classList.contains("hidden")||n.parentElement&&!n.parentElement.contains(o)&&n.classList.add("hidden")})});function H(){let e=window.location.pathname,o=e.match(/^\/statistics\/(books|comics)?/);if(o)return{type:"statistics",scope:o[1]||"all"};let t=e.match(/^\/recap\/(\d{4})\/(books|comics)?/);if(t){let r=t[1];return{type:"recap",scope:t[2]||"all",year:r}}return{type:null,scope:"all"}}function U(){let e=H();e.type==="statistics"?i.set(i.KEYS.STATS_FILTER,e.scope):e.type==="recap"&&i.set(i.KEYS.RECAP_FILTER,e.scope)}function R(e,o){return o==="all"?e:(e.endsWith("/")?e:e+"/")+o+"/"}function V(){let e=document.querySelectorAll("#nav-statistics"),o=document.querySelectorAll("#nav-recap");e.forEach(t=>{t.addEventListener("click",r=>{let n=i.get(i.KEYS.STATS_FILTER);if(n&&n!=="all"){r.preventDefault();let c=R(t.href,n);window.location.href=c}})}),o.forEach(t=>{t.addEventListener("click",r=>{let n=i.get(i.KEYS.RECAP_FILTER);if(n&&n!=="all"){r.preventDefault();let c=R(t.href,n);window.location.href=c}})})}document.addEventListener("DOMContentLoaded",()=>{U(),V()});function q(){let e=navigator.userAgent,o=/AppleWebKit/i.test(e),t=/iP(hone|ad|od)/i.test(e),r=/Macintosh/i.test(e)&&/Safari/i.test(e)&&!/Chrome|CriOS|Edg|OPR|Firefox/i.test(e);return o&&(t||r)}function T(e){return e<640?"xs":e<768?"sm":e<1024?"md":e<1280?"lg":e<1536?"xl":"2xl"}var A=!1;function k(){if(!q()||A)return;A=!0,console.debug("[KoShelf] WebKit repaint hack active");let e=T(window.innerWidth),o=!1,t=()=>{if(window.scrollY!==0)return;let n=T(window.innerWidth);if(n===e)return;e=n;let c=document.documentElement,d=document.body,l=c.style.overflowY,a=d.style.overflowY,s=c.scrollHeight<=window.innerHeight+1?document.createElement("div"):null;s&&(s.setAttribute("data-safari-repaint-spacer","true"),s.style.height="2px",s.style.width="1px",s.style.pointerEvents="none",d.appendChild(s)),c.style.overflowY="scroll",d.style.overflowY="scroll",requestAnimationFrame(()=>{window.scrollY===0&&window.scrollBy(0,1),requestAnimationFrame(()=>{window.scrollY===1&&window.scrollTo(0,0),s?.remove(),c.style.overflowY=l,d.style.overflowY=a})})},r=()=>{o||(o=!0,requestAnimationFrame(()=>{o=!1,t()}))};window.addEventListener("resize",r,{passive:!0}),window.addEventListener("orientationchange",r,{passive:!0}),window.addEventListener("pageshow",r,{passive:!0}),window.visualViewport?.addEventListener("resize",r,{passive:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>k()):k();async function O(){let e=document.getElementById("lang-select");if(!e)return;let o=t=>{let n=`; ${document.cookie}`.split(`; ${t}=`);return n.length===2&&n.pop()?.split(";").shift()||null};try{let t=await fetch("/api/languages");if(!t.ok)throw new Error("Failed to load languages");let r=await t.json();e.innerHTML="";let n=o("koshelf_lang"),c=document.documentElement.lang,d=n||c||"en";r.forEach(l=>{let a=document.createElement("option");a.value=l.code,a.textContent=l.name,(l.code===d||d.startsWith(l.code)&&l.code.length>1)&&(a.selected=!0),e.appendChild(a)}),e.addEventListener("change",async l=>{let a=l.target,E=a.value;a.disabled=!0,document.body.style.cursor="wait";try{document.cookie=`koshelf_lang=${E};path=/;max-age=31536000;SameSite=Strict`;let s=await fetch("/api/settings/language",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lang:E})});if(s.ok){if("caches"in window)try{let g=await caches.keys();await Promise.all(g.map(m=>caches.delete(m))),console.log("PWA Cache cleared")}catch(g){console.warn("Failed to clear caches",g)}if("serviceWorker"in navigator){let g=await navigator.serviceWorker.getRegistrations();for(let m of g)await m.unregister()}let h=new URL(window.location.href);h.searchParams.set("t",Date.now().toString()),window.location.href=h.toString()}else console.error("Server error:",await s.text()),alert("Error updating language."),a.disabled=!1,document.body.style.cursor="default"}catch(s){console.error("Connection error:",s),a.disabled=!1,document.body.style.cursor="default"}})}catch(t){console.error("Language selector error:",t),e.innerHTML="<option disabled>Error</option>"}}document.addEventListener("DOMContentLoaded",()=>{O()});
