var i=class{static get(t,o=null){try{let r=localStorage.getItem(this.PREFIX+t);return r===null?o:JSON.parse(r)}catch(r){return console.warn("StorageManager: Failed to parse item",r),o}}static set(t,o){try{localStorage.setItem(this.PREFIX+t,JSON.stringify(o))}catch(r){console.warn("StorageManager: Failed to save item",r)}}static remove(t){localStorage.removeItem(this.PREFIX+t)}};i.PREFIX="koshelf_",i.KEYS={RECAP_FILTER:"recap_filter",STATS_FILTER:"stats_filter",LIBRARY_LIST_BOOKS_FILTER:"library_list_books_filter",LIBRARY_LIST_COMICS_FILTER:"library_list_comics_filter",LIBRARY_LIST_BOOKS_SECTIONS:"library_list_books_sections",LIBRARY_LIST_COMICS_SECTIONS:"library_list_comics_sections",ITEM_DETAIL_BOOKS_SECTIONS:"item_detail_books_sections",ITEM_DETAIL_COMICS_SECTIONS:"item_detail_comics_sections",STATS_ALL_SECTIONS:"stats_all_sections",STATS_BOOKS_SECTIONS:"stats_books_sections",STATS_COMICS_SECTIONS:"stats_comics_sections",RECAP_SORT_NEWEST:"recap_sort_newest",VERSION:"version",SERVER_MODE:"server_mode",RELOAD_COUNT:"reload_count",LAST_RELOAD:"last_reload"};var u=i.KEYS,k={maxRetries:3,cooldownMs:6e4},M=5e3,N=1e4,D="{{SERVER_MODE}}",m=i.get(u.VERSION),y=null;"serviceWorker"in navigator&&Y();function A(e,t){if(e===null)return t;let o=Number.parseInt(e,10);return Number.isFinite(o)?o:t}async function Y(){try{await navigator.serviceWorker.register("/service-worker.js")}catch(e){console.error("[PWA] Service Worker registration failed:",e),v()}navigator.serviceWorker.addEventListener("message",B),window.addEventListener("error",F),window.addEventListener("unhandledrejection",K),setTimeout(x,1e3)}function B({data:e}){e?.type==="CACHE_UPDATED"?O():e?.type==="CRITICAL_ERROR"&&(console.error("[PWA] Service Worker critical error:",e.error),v())}function F(e){(e.error||e.message)&&(console.error("[PWA] Window error detected:",e.error||e.message),v())}function K(e){e.reason?console.error("[PWA] Unhandled rejection detected:",e.reason):console.error("[PWA] Unhandled rejection detected"),v()}function v(){let e=Date.now(),t=A(i.get(u.LAST_RELOAD),0),o=A(i.get(u.RELOAD_COUNT),0);if(e-t>k.cooldownMs&&(o=0),o>=k.maxRetries){console.error("[PWA] Recovery limit reached, stopping auto-reload");return}i.set(u.RELOAD_COUNT,String(o+1)),i.set(u.LAST_RELOAD,String(e)),console.log("[PWA] Attempting recovery reload..."),navigator.serviceWorker.getRegistrations().then(r=>r.forEach(n=>n.unregister())).then(()=>location.reload())}async function x(){let e=await L();e&&h(e),D==="internal"?U():q()}async function L(){try{let e=await fetch("/version.txt",{cache:"no-store"});return e.ok?(await e.text()).trim():null}catch{return null}}function h(e){if(console.log(`[PWA] Version check: stored=${m}, fetched=${e}, lastNotified=${y}`),m===null){m=e,i.set(u.VERSION,e),console.log("[PWA] First load, storing initial version");return}m!==e&&y!==e&&(console.log("[PWA] Version changed! Requesting cache update..."),y=e,i.set(u.VERSION,e),H())}function H(){navigator.serviceWorker.controller?(console.log("[PWA] Sending CHECK_FOR_UPDATES to service worker"),navigator.serviceWorker.controller.postMessage({type:"CHECK_FOR_UPDATES"})):(console.log("[PWA] No SW controller, showing notification directly"),O())}async function U(){for(;;)try{let e=await fetch("/api/events/version",{cache:"no-store"});e.status===200&&h((await e.text()).trim())}catch{await V()}}async function V(){for(;;){await j(M);let e=await L();if(e){h(e);return}}}function q(){setInterval(async()=>{let e=await L();e&&h(e)},N)}function O(){document.body.classList.add("update-available")}function j(e){return new Promise(t=>setTimeout(t,e))}document.addEventListener("click",e=>{let t=e.target instanceof Node?e.target:null;if(!t)return;document.querySelectorAll("details[open]").forEach(n=>{n.contains(t)||n.removeAttribute("open")}),document.querySelectorAll(".dropdown-menu, .dropdown-menu-right").forEach(n=>{n.closest("details")||n.classList.contains("hidden")||n.parentElement&&!n.parentElement.contains(t)&&n.classList.add("hidden")})});function $(){let e=window.location.pathname,t=e.match(/^\/statistics\/(books|comics)?/);if(t)return{type:"statistics",scope:t[1]||"all"};let o=e.match(/^\/recap\/(\d{4})\/(books|comics)?/);if(o){let r=o[1];return{type:"recap",scope:o[2]||"all",year:r}}return{type:null,scope:"all"}}function z(){let e=$();e.type==="statistics"?i.set(i.KEYS.STATS_FILTER,e.scope):e.type==="recap"&&i.set(i.KEYS.RECAP_FILTER,e.scope)}function I(e,t){return t==="all"?e:(e.endsWith("/")?e:e+"/")+t+"/"}function X(){let e=document.querySelectorAll("#nav-statistics"),t=document.querySelectorAll("#nav-recap");e.forEach(o=>{o.addEventListener("click",r=>{let n=i.get(i.KEYS.STATS_FILTER);if(n&&n!=="all"){r.preventDefault();let a=I(o.href,n);window.location.href=a}})}),t.forEach(o=>{o.addEventListener("click",r=>{let n=i.get(i.KEYS.RECAP_FILTER);if(n&&n!=="all"){r.preventDefault();let a=I(o.href,n);window.location.href=a}})})}document.addEventListener("DOMContentLoaded",()=>{z(),X()});function J(){let e=navigator.userAgent,t=/AppleWebKit/i.test(e),o=/iP(hone|ad|od)/i.test(e),r=/Macintosh/i.test(e)&&/Safari/i.test(e)&&!/Chrome|CriOS|Edg|OPR|Firefox/i.test(e);return t&&(o||r)}function C(e){return e<640?"xs":e<768?"sm":e<1024?"md":e<1280?"lg":e<1536?"xl":"2xl"}var b=!1;function P(){if(!J()||b)return;b=!0,console.debug("[KoShelf] WebKit repaint hack active");let e=C(window.innerWidth),t=!1,o=()=>{if(window.scrollY!==0)return;let n=C(window.innerWidth);if(n===e)return;e=n;let a=document.documentElement,s=document.body,l=a.style.overflowY,g=s.style.overflowY,c=a.scrollHeight<=window.innerHeight+1?document.createElement("div"):null;c&&(c.setAttribute("data-safari-repaint-spacer","true"),c.style.height="2px",c.style.width="1px",c.style.pointerEvents="none",s.appendChild(c)),a.style.overflowY="scroll",s.style.overflowY="scroll",requestAnimationFrame(()=>{window.scrollY===0&&window.scrollBy(0,1),requestAnimationFrame(()=>{window.scrollY===1&&window.scrollTo(0,0),c?.remove(),a.style.overflowY=l,s.style.overflowY=g})})},r=()=>{t||(t=!0,requestAnimationFrame(()=>{t=!1,o()}))};window.addEventListener("resize",r,{passive:!0}),window.addEventListener("orientationchange",r,{passive:!0}),window.addEventListener("pageshow",r,{passive:!0}),window.visualViewport?.addEventListener("resize",r,{passive:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>P()):P();async function W(){let e=document.getElementById("desktop-settings-btn"),t=document.getElementById("desktop-settings-menu");e&&t&&(e.addEventListener("click",s=>{s.stopPropagation(),t.classList.toggle("hidden")}),document.addEventListener("click",s=>{let l=s.target;!t.contains(l)&&!e.contains(l)&&t.classList.add("hidden")}));let o=document.getElementById("lang-select"),r=document.getElementById("mobile-lang-select"),n=[o,r].filter(s=>s!==null);if(n.length===0)return;let a=s=>{let g=`; ${document.cookie}`.split(`; ${s}=`);return g.length===2&&g.pop()?.split(";").shift()||null};try{let s=await fetch("/api/languages");if(!s.ok)throw new Error("Failed to load languages");let l=await s.json(),g=a("koshelf_lang"),R=document.documentElement.lang,c=g||R||"en";n.forEach(w=>{w.innerHTML="",l.forEach(d=>{let E=document.createElement("option");E.value=d.code,E.textContent=d.name,(d.code===c||c.startsWith(d.code)&&d.code.length>1)&&(E.selected=!0),w.appendChild(E)}),w.addEventListener("change",async d=>{let T=d.target.value;n.forEach(p=>p.disabled=!0),document.body.style.cursor="wait";try{document.cookie=`koshelf_lang=${T};path=/;max-age=31536000;SameSite=Strict`;let p=await fetch("/api/settings/language",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lang:T})});if(p.ok){if("caches"in window)try{let S=await caches.keys();await Promise.all(S.map(_=>caches.delete(_)))}catch(S){console.warn(S)}if("serviceWorker"in navigator){let S=await navigator.serviceWorker.getRegistrations();for(let _ of S)await _.unregister()}let f=new URL(window.location.href);f.searchParams.set("t",Date.now().toString()),window.location.href=f.toString()}else console.error("Server error:",await p.text()),n.forEach(f=>f.disabled=!1),document.body.style.cursor="default"}catch(p){console.error(p),n.forEach(f=>f.disabled=!1),document.body.style.cursor="default"}})})}catch(s){console.error("Language selector error:",s),n.forEach(l=>l.innerHTML="<option disabled>Error</option>")}}document.addEventListener("DOMContentLoaded",()=>{W()});
