var q=new Map,J=!1;function Q(r,e){!r||!e||(r.classList.remove("hidden"),r.classList.add("flex"),r.classList.add("opacity-0"),e.classList.add("scale-95","opacity-0"),r.offsetHeight,requestAnimationFrame(()=>{r.classList.remove("opacity-0"),r.classList.add("opacity-100"),e.classList.remove("scale-95","opacity-0"),e.classList.add("scale-100","opacity-100")}))}function Ee(r,e){!r||!e||(r.classList.remove("opacity-100"),r.classList.add("opacity-0"),e.classList.remove("scale-100","opacity-100"),e.classList.add("scale-95","opacity-0"),setTimeout(()=>{r.classList.add("hidden"),r.classList.remove("flex")},300))}function ye(){J||(J=!0,document.addEventListener("keydown",r=>{if(r.key==="Escape")for(let{modal:e,hide:t}of q.values())e.classList.contains("hidden")||t()}))}function ee(r,e,t=null){if(!r||!e)return;let n=q.get(r);if(n)return n.hide;let o=()=>Ee(r,e),s=l=>{l.target===r&&o()};return r.addEventListener("click",s),t?.addEventListener("click",o),q.set(r,{modal:r,modalCard:e,hide:o,onBackdropClick:s,closeBtn:t}),ye(),o}var R=class{constructor(e){this.value=e}valueOf(){return this.value}},u=class extends R{constructor(e="???"){super(e)}toString(e){return`{${this.value}}`}},g=class extends R{constructor(e,t={}){super(e),this.opts=t}toString(e){try{return e.memoizeIntlObject(Intl.NumberFormat,this.opts).format(this.value)}catch(t){return e.reportError(t),this.value.toString(10)}}},_=class extends R{constructor(e,t={}){super(e),this.opts=t}toString(e){try{return e.memoizeIntlObject(Intl.DateTimeFormat,this.opts).format(this.value)}catch(t){return e.reportError(t),new Date(this.value).toISOString()}}};var te=100,ge="\u2068",ve="\u2069";function we(r,e,t){if(t===e||t instanceof g&&e instanceof g&&t.value===e.value)return!0;if(e instanceof g&&typeof t=="string"){let n=r.memoizeIntlObject(Intl.PluralRules,e.opts).select(e.value);if(t===n)return!0}return!1}function re(r,e,t){return e[t]?N(r,e[t].value):(r.reportError(new RangeError("No default")),new u)}function V(r,e){let t=[],n=Object.create(null);for(let o of e)o.type==="narg"?n[o.name]=k(r,o.value):t.push(k(r,o));return{positional:t,named:n}}function k(r,e){switch(e.type){case"str":return e.value;case"num":return new g(e.value,{minimumFractionDigits:e.precision});case"var":return Se(r,e);case"mesg":return be(r,e);case"term":return _e(r,e);case"func":return Te(r,e);case"select":return xe(r,e);default:return new u}}function Se(r,{name:e}){let t;if(r.params)if(Object.prototype.hasOwnProperty.call(r.params,e))t=r.params[e];else return new u(`$${e}`);else if(r.args&&Object.prototype.hasOwnProperty.call(r.args,e))t=r.args[e];else return r.reportError(new ReferenceError(`Unknown variable: $${e}`)),new u(`$${e}`);if(t instanceof R)return t;switch(typeof t){case"string":return t;case"number":return new g(t);case"object":if(t instanceof Date)return new _(t.getTime());default:return r.reportError(new TypeError(`Variable type not supported: $${e}, ${typeof t}`)),new u(`$${e}`)}}function be(r,{name:e,attr:t}){let n=r.bundle._messages.get(e);if(!n)return r.reportError(new ReferenceError(`Unknown message: ${e}`)),new u(e);if(t){let o=n.attributes[t];return o?N(r,o):(r.reportError(new ReferenceError(`Unknown attribute: ${t}`)),new u(`${e}.${t}`))}return n.value?N(r,n.value):(r.reportError(new ReferenceError(`No value: ${e}`)),new u(e))}function _e(r,{name:e,attr:t,args:n}){let o=`-${e}`,s=r.bundle._terms.get(o);if(!s)return r.reportError(new ReferenceError(`Unknown term: ${o}`)),new u(o);if(t){let f=s.attributes[t];if(f){r.params=V(r,n).named;let w=N(r,f);return r.params=null,w}return r.reportError(new ReferenceError(`Unknown attribute: ${t}`)),new u(`${o}.${t}`)}r.params=V(r,n).named;let l=N(r,s.value);return r.params=null,l}function Te(r,{name:e,args:t}){let n=r.bundle._functions[e];if(!n)return r.reportError(new ReferenceError(`Unknown function: ${e}()`)),new u(`${e}()`);if(typeof n!="function")return r.reportError(new TypeError(`Function ${e}() is not callable`)),new u(`${e}()`);try{let o=V(r,t);return n(o.positional,o.named)}catch(o){return r.reportError(o),new u(`${e}()`)}}function xe(r,{selector:e,variants:t,star:n}){let o=k(r,e);if(o instanceof u)return re(r,t,n);for(let s of t){let l=k(r,s.key);if(we(r,o,l))return N(r,s.value)}return re(r,t,n)}function z(r,e){if(r.dirty.has(e))return r.reportError(new RangeError("Cyclic reference")),new u;r.dirty.add(e);let t=[],n=r.bundle._useIsolating&&e.length>1;for(let o of e){if(typeof o=="string"){t.push(r.bundle._transform(o));continue}if(r.placeables++,r.placeables>te)throw r.dirty.delete(e),new RangeError(`Too many placeables expanded: ${r.placeables}, max allowed is ${te}`);n&&t.push(ge),t.push(k(r,o).toString(r)),n&&t.push(ve)}return r.dirty.delete(e),t.join("")}function N(r,e){return typeof e=="string"?r.bundle._transform(e):z(r,e)}var H=class{constructor(e,t,n){this.dirty=new WeakSet,this.params=null,this.placeables=0,this.bundle=e,this.errors=t,this.args=n}reportError(e){if(!this.errors||!(e instanceof Error))throw e;this.errors.push(e)}memoizeIntlObject(e,t){let n=this.bundle._intls.get(e);n||(n={},this.bundle._intls.set(e,n));let o=JSON.stringify(t);return n[o]||(n[o]=new e(this.bundle.locales,t)),n[o]}};function Z(r,e){let t=Object.create(null);for(let[n,o]of Object.entries(r))e.includes(n)&&(t[n]=o.valueOf());return t}var ne=["unitDisplay","currencyDisplay","useGrouping","minimumIntegerDigits","minimumFractionDigits","maximumFractionDigits","minimumSignificantDigits","maximumSignificantDigits"];function oe(r,e){let t=r[0];if(t instanceof u)return new u(`NUMBER(${t.valueOf()})`);if(t instanceof g)return new g(t.valueOf(),{...t.opts,...Z(e,ne)});if(t instanceof _)return new g(t.valueOf(),{...Z(e,ne)});throw new TypeError("Invalid argument to NUMBER")}var ae=["dateStyle","timeStyle","fractionalSecondDigits","dayPeriod","hour12","weekday","era","year","month","day","hour","minute","second","timeZoneName"];function se(r,e){let t=r[0];if(t instanceof u)return new u(`DATETIME(${t.valueOf()})`);if(t instanceof _)return new _(t.valueOf(),{...t.opts,...Z(e,ae)});if(t instanceof g)return new _(t.valueOf(),{...Z(e,ae)});throw new TypeError("Invalid argument to DATETIME")}var ie=new Map;function le(r){let e=Array.isArray(r)?r.join(" "):r,t=ie.get(e);return t===void 0&&(t=new Map,ie.set(e,t)),t}var C=class{constructor(e,{functions:t,useIsolating:n=!0,transform:o=s=>s}={}){this._terms=new Map,this._messages=new Map,this.locales=Array.isArray(e)?e:[e],this._functions={NUMBER:oe,DATETIME:se,...t},this._useIsolating=n,this._transform=o,this._intls=le(e)}hasMessage(e){return this._messages.has(e)}getMessage(e){return this._messages.get(e)}addResource(e,{allowOverrides:t=!1}={}){let n=[];for(let o=0;o<e.body.length;o++){let s=e.body[o];if(s.id.startsWith("-")){if(t===!1&&this._terms.has(s.id)){n.push(new Error(`Attempt to override an existing term: "${s.id}"`));continue}this._terms.set(s.id,s)}else{if(t===!1&&this._messages.has(s.id)){n.push(new Error(`Attempt to override an existing message: "${s.id}"`));continue}this._messages.set(s.id,s)}}return n}formatPattern(e,t=null,n=null){if(typeof e=="string")return this._transform(e);let o=new H(this,n,t);try{return z(o,e).toString(o)}catch(s){if(o.errors&&s instanceof Error)return o.errors.push(s),new u().toString(o);throw s}}};var W=/^(-?[a-zA-Z][\w-]*) *= */gm,ue=/\.([a-zA-Z][\w-]*) *= */y,Me=/\*?\[/y,X=/(-?[0-9]+(?:\.([0-9]+))?)/y,Oe=/([a-zA-Z][\w-]*)/y,ce=/([$-])?([a-zA-Z][\w-]*)(?:\.([a-zA-Z][\w-]*))?/y,Re=/^[A-Z][A-Z0-9_-]*$/,j=/([^{}\n\r]+)/y,Le=/([^\\"\n\r]*)/y,fe=/\\([\\"])/y,de=/\\u([a-fA-F0-9]{4})|\\U([a-fA-F0-9]{6})/y,Ie=/^\n+/,he=/ +$/,Ae=/ *\r?\n/g,$e=/( *)$/,Ne=/{\s*/y,me=/\s*}/y,Ce=/\[\s*/y,Fe=/\s*] */y,Be=/\s*\(\s*/y,De=/\s*->\s*/y,ke=/\s*:\s*/y,Pe=/\s*,?\s*/y,Ke=/\s+/y,P=class{constructor(e){this.body=[],W.lastIndex=0;let t=0;for(;;){let a=W.exec(e);if(a===null)break;t=W.lastIndex;try{this.body.push(w(a[1]))}catch(i){if(i instanceof SyntaxError)continue;throw i}}function n(a){return a.lastIndex=t,a.test(e)}function o(a,i){if(e[t]===a)return t++,!0;if(i)throw new i(`Expected ${a}`);return!1}function s(a,i){if(n(a))return t=a.lastIndex,!0;if(i)throw new i(`Expected ${a.toString()}`);return!1}function l(a){a.lastIndex=t;let i=a.exec(e);if(i===null)throw new SyntaxError(`Expected ${a.toString()}`);return t=a.lastIndex,i}function f(a){return l(a)[1]}function w(a){let i=m(),c=F();if(i===null&&Object.keys(c).length===0)throw new SyntaxError("Expected message value or attributes");return{id:a,value:i,attributes:c}}function F(){let a=Object.create(null);for(;n(ue);){let i=f(ue),c=m();if(c===null)throw new SyntaxError("Expected attribute value");a[i]=c}return a}function m(){let a;if(n(j)&&(a=f(j)),e[t]==="{"||e[t]==="}")return T(a?[a]:[],1/0);let i=K();return i?a?T([a,i],i.length):(i.value=B(i.value,Ie),T([i],i.length)):a?B(a,he):null}function T(a=[],i){for(;;){if(n(j)){a.push(f(j));continue}if(e[t]==="{"){a.push(I());continue}if(e[t]==="}")throw new SyntaxError("Unbalanced closing brace");let b=K();if(b){a.push(b),i=Math.min(i,b.length);continue}break}let c=a.length-1,$=a[c];typeof $=="string"&&(a[c]=B($,he));let D=[];for(let b of a)b instanceof Y&&(b=b.value.slice(0,b.value.length-i)),b&&D.push(b);return D}function I(){s(Ne,SyntaxError);let a=O();if(s(me))return a;if(s(De)){let i=h();return s(me,SyntaxError),{type:"select",selector:a,...i}}throw new SyntaxError("Unclosed placeable")}function O(){if(e[t]==="{")return I();if(n(ce)){let[,a,i,c=null]=l(ce);if(a==="$")return{type:"var",name:i};if(s(Be)){let $=d();if(a==="-")return{type:"term",name:i,attr:c,args:$};if(Re.test(i))return{type:"func",name:i,args:$};throw new SyntaxError("Function names must be all upper-case")}return a==="-"?{type:"term",name:i,attr:c,args:[]}:{type:"mesg",name:i,attr:c}}return S()}function d(){let a=[];for(;;){switch(e[t]){case")":return t++,a;case void 0:throw new SyntaxError("Unclosed argument list")}a.push(p()),s(Pe)}}function p(){let a=O();return a.type!=="mesg"?a:s(ke)?{type:"narg",name:a.name,value:S()}:a}function h(){let a=[],i=0,c;for(;n(Me);){o("*")&&(c=i);let $=y(),D=m();if(D===null)throw new SyntaxError("Expected variant value");a[i++]={key:$,value:D}}if(i===0)return null;if(c===void 0)throw new SyntaxError("Expected default variant");return{variants:a,star:c}}function y(){s(Ce,SyntaxError);let a;return n(X)?a=v():a={type:"str",value:f(Oe)},s(Fe,SyntaxError),a}function S(){if(n(X))return v();if(e[t]==='"')return E();throw new SyntaxError("Invalid expression")}function v(){let[,a,i=""]=l(X),c=i.length;return{type:"num",value:parseFloat(a),precision:c}}function E(){o('"',SyntaxError);let a="";for(;;){if(a+=f(Le),e[t]==="\\"){a+=A();continue}if(o('"'))return{type:"str",value:a};throw new SyntaxError("Unclosed string literal")}}function A(){if(n(fe))return f(fe);if(n(de)){let[,a,i]=l(de),c=parseInt(a||i,16);return c<=55295||57344<=c?String.fromCodePoint(c):"\uFFFD"}throw new SyntaxError("Unknown escape sequence")}function K(){let a=t;switch(s(Ke),e[t]){case".":case"[":case"*":case"}":case void 0:return!1;case"{":return U(e.slice(a,t))}return e[t-1]===" "?U(e.slice(a,t)):!1}function B(a,i){return a.replace(i,"")}function U(a){let i=a.replace(Ae,`
`),c=$e.exec(a)[1].length;return new Y(i,c)}}},Y=class{constructor(e,t){this.value=e,this.length=t}};var L=null,G=null;async function Ue(){if(!L)try{let e=await(await fetch(`/assets/json/locales.json?t=${Date.now()}`)).json();L=new C(e.language);for(let t of e.resources){let n=new P(t);L.addResource(n)}}catch(r){console.warn("Failed to load translations:",r),L=new C("en-US")}}var x={async init(){G||(G=Ue()),await G},get(r,e){if(!L)return r;let t;typeof e=="number"?t={count:e}:t=e;let n=r,o,s=r.indexOf(".");s!==-1&&(n=r.substring(0,s),o=r.substring(s+1));let l=L.getMessage(n);if(!l)return r;let f;return o?f=l.attributes?.[o]:f=l.value,f?L.formatPattern(f,t):r},getLanguage(){return L?.locales[0]||"en-US"}};var He={maxRotation:4,transitionDuration:150,perspective:800,hoverScale:1.02,hoverLift:4,shadowBlur:15,shadowOpacity:.2,enableOverlays:!1,overlayFloatZ:10,overlayScale:1.05,parallaxMultiplier:.3,overlayContainer:".aspect-book",badgeSelector:'[class*="absolute"][class*="top-"]',progressBarSelector:".book-progress-bar"};function Ze(r){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||!window.matchMedia("(pointer: fine)").matches)return;let e={...He,...r};document.querySelectorAll(e.selector).forEach(n=>{n.style.transformStyle="preserve-3d",n.style.transformOrigin="center center",n.style.willChange="transform, box-shadow",n.style.backfaceVisibility="hidden",n.style.transform="translateZ(0)";let o=null,s=null,l=null;e.enableOverlays&&e.overlayContainer&&(o=n.querySelector(e.overlayContainer),o&&(o.style.transformStyle="preserve-3d",o.style.backfaceVisibility="hidden"),s=n.querySelectorAll(e.badgeSelector),l=n.querySelector(e.progressBarSelector),s?.forEach(m=>{m.style.willChange="transform",m.style.backfaceVisibility="hidden",m.style.transform="translateZ(0)"}),l&&(l.style.willChange="transform",l.style.backfaceVisibility="hidden",l.style.transform="translateZ(0)"));let f=null,w=null;n.addEventListener("mouseenter",()=>{n.style.transition=`transform ${e.transitionDuration}ms ease-out, box-shadow ${e.transitionDuration}ms ease-out`,n.style.boxShadow=`0px 8px ${e.shadowBlur}px rgba(0, 0, 0, ${e.shadowOpacity*.5})`,e.enableOverlays&&s&&s.forEach(m=>{m.style.transition=`transform ${e.transitionDuration}ms ease-out`,m.style.transform=`translateZ(${e.overlayFloatZ}px) scale(${e.overlayScale})`}),e.enableOverlays&&l&&(l.style.transition=`transform ${e.transitionDuration}ms ease-out`,l.style.transform=`translateZ(${e.overlayFloatZ}px)`)});let F=()=>{if(!w)return;let m=w,T=n.getBoundingClientRect(),I=(m.clientX-T.left)/T.width,O=(m.clientY-T.top)/T.height,d=(.5-I)*2*e.maxRotation,p=(O-.5)*2*e.maxRotation,h=-d*1.5,y=p*1.5+8;if(n.style.transition=`transform ${e.transitionDuration}ms ease-out, box-shadow ${e.transitionDuration}ms ease-out`,n.style.transform=`perspective(${e.perspective}px) rotateX(${p}deg) rotateY(${d}deg) scale(${e.hoverScale}) translateY(-${e.hoverLift}px) translateZ(0)`,n.style.boxShadow=`${h}px ${y}px ${e.shadowBlur}px rgba(0, 0, 0, ${e.shadowOpacity})`,e.enableOverlays){let S=d*e.parallaxMultiplier,v=-p*e.parallaxMultiplier;s?.forEach(E=>{E.style.transform=`translateZ(${e.overlayFloatZ}px) translate(${S}px, ${v}px) scale(${e.overlayScale})`}),l&&(l.style.transform=`translateZ(${e.overlayFloatZ}px) translateX(${S}px)`)}w=null,f=null};n.addEventListener("mousemove",m=>{w=m,f||(f=requestAnimationFrame(F))}),n.addEventListener("mouseleave",()=>{f&&(cancelAnimationFrame(f),f=null,w=null),n.style.transition=`transform ${e.transitionDuration*2}ms ease-out, box-shadow ${e.transitionDuration*2}ms ease-out`,n.style.transform="translateZ(0)",n.style.boxShadow="",e.enableOverlays&&(s?.forEach(m=>{m.style.transition=`transform ${e.transitionDuration*2}ms ease-out`,m.style.transform="translateZ(0)"}),l&&(l.style.transition=`transform ${e.transitionDuration*2}ms ease-out`,l.style.transform="translateZ(0)"))})})}function pe(){Ze({selector:".recap-cover-tilt",maxRotation:3,hoverScale:1.02,hoverLift:3,shadowBlur:20,shadowOpacity:.15,enableOverlays:!1})}var M=class{static get(e,t=null){try{let n=localStorage.getItem(this.PREFIX+e);return n===null?t:JSON.parse(n)}catch(n){return console.warn("StorageManager: Failed to parse item",n),t}}static set(e,t){try{localStorage.setItem(this.PREFIX+e,JSON.stringify(t))}catch(n){console.warn("StorageManager: Failed to save item",n)}}static remove(e){localStorage.removeItem(this.PREFIX+e)}};M.PREFIX="koshelf_",M.KEYS={RECAP_FILTER:"recap_filter",STATS_FILTER:"stats_filter",LIBRARY_LIST_BOOKS_FILTER:"library_list_books_filter",LIBRARY_LIST_COMICS_FILTER:"library_list_comics_filter",LIBRARY_LIST_BOOKS_SECTIONS:"library_list_books_sections",LIBRARY_LIST_COMICS_SECTIONS:"library_list_comics_sections",ITEM_DETAIL_BOOKS_SECTIONS:"item_detail_books_sections",ITEM_DETAIL_COMICS_SECTIONS:"item_detail_comics_sections",STATS_ALL_SECTIONS:"stats_all_sections",STATS_BOOKS_SECTIONS:"stats_books_sections",STATS_COMICS_SECTIONS:"stats_comics_sections",RECAP_SORT_NEWEST:"recap_sort_newest",VERSION:"version",SERVER_MODE:"server_mode",RELOAD_COUNT:"reload_count",LAST_RELOAD:"last_reload"};document.addEventListener("DOMContentLoaded",async()=>{await x.init(),pe();let r=document.getElementById("yearSelectorWrapper"),e=document.getElementById("yearOptions");if(r&&e){r.addEventListener("click",()=>{e.classList.toggle("hidden")});let d=document.body.getAttribute("data-recap-scope")||"all",p=d==="all"?"":`${d}/`;document.querySelectorAll(".year-option").forEach(h=>{h.addEventListener("click",()=>{let y=h.getAttribute("data-year");y&&(window.location.href=`/recap/${y}/${p}`)})})}let t=document.getElementById("sortToggle"),n=document.getElementById("recapTimeline");if(t&&n){let d=M.get(M.KEYS.RECAP_SORT_NEWEST,!0)??!0,p='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h8M4 12h8M4 17h5M18 6v12M15 15l3 3 3-3"></path>',h='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h5M4 12h8M4 17h8M18 18V6M15 9l3-3 3 3"></path>',y=()=>{let v=t.querySelector("svg");v&&(v.innerHTML=d?p:h);let E=d?x.get("sort-order.newest-first"):x.get("sort-order.oldest-first");t.title=E,t.setAttribute("aria-label",E)},S=()=>{let v=Array.from(n.querySelectorAll(".month-group"));v.reverse().forEach(E=>n.appendChild(E)),v.forEach(E=>{let A=Array.from(E.children);if(A.length>1){let K=A[0],B=A.slice(1);E.innerHTML="",E.appendChild(K),B.reverse().forEach(U=>E.appendChild(U))}})};d||(y(),S()),t.addEventListener("click",()=>{d=!d,M.set(M.KEYS.RECAP_SORT_NEWEST,d),y(),S()})}let o=document.getElementById("shareButton"),s=document.getElementById("shareModal"),l=document.getElementById("shareModalCard"),f=document.getElementById("shareModalClose"),w=document.getElementById("shareModalTitle"),F=()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||navigator.maxTouchPoints!==void 0&&navigator.maxTouchPoints>2,m=()=>typeof navigator.share=="function"&&typeof navigator.canShare=="function",I=F()&&m();I&&(w&&(w.textContent=x.get("share.recap-label")),document.querySelectorAll(".share-btn-text").forEach(d=>{d.textContent=x.get("share")}),o&&(o.title=x.get("share.recap-label"),o.setAttribute("aria-label",x.get("share.recap-label")))),o&&s&&l&&(o.addEventListener("click",()=>{Q(s,l)}),ee(s,l,f),document.querySelectorAll(".share-webp-btn").forEach(d=>{d.addEventListener("click",async()=>{let p=d.dataset.shareUrl,h=d.dataset.shareFilename;if(!(!p||!h))if(I)try{let S=await(await fetch(p)).blob(),v=new File([S],h,{type:"image/webp"});if(navigator.canShare&&navigator.canShare({files:[v]})){let E=h.match(/koshelf_(\d{4})_/),A=E?E[1]:String(new Date().getFullYear());await navigator.share({files:[v],title:x.get("my-reading-recap"),text:`\u{1F4DA} My ${A} reading journey! These graphics were crafted by KoShelf, my KoReader reading companion. Check it out: https://github.com/zanivann/KoShelf`})}else O(p,h)}catch(y){y instanceof Error&&y.name!=="AbortError"&&(console.error("Share failed:",y),O(p,h))}else O(p,h)})}));function O(d,p){let h=document.createElement("a");h.href=d,h.download=p,document.body.appendChild(h),h.click(),document.body.removeChild(h)}});
