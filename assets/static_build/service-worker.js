var o=self,i="koshelf-cache-v2",h="/cache-manifest.json",g=10,w=["/version.txt","/api/events/version","/service-worker.js","/cache-manifest.json"];o.onerror=e=>{let t=typeof e=="string"?e:e.message;return console.error("[SW] Critical error:",t),l({type:"CRITICAL_ERROR",error:String(t)}),!1};o.onunhandledrejection=e=>{console.error("[SW] Unhandled rejection:",e.reason),l({type:"CRITICAL_ERROR",error:String(e.reason||"Unhandled Rejection")})};async function l(e){(await o.clients.matchAll()).forEach(n=>n.postMessage(e))}function C(e){let t=new URL(e).pathname;return w.some(n=>t.endsWith(n))}function d(e){return new URL(e,o.location.origin).href}function y(e){let t=new URL(e),n=t.pathname;return t.search="",n.endsWith("/index.html")&&(n=n.slice(0,-10),t.pathname=n),t.href}async function u(e,t){for(let n=0;n<t.length;n+=g){let a=t.slice(n,n+g);await Promise.all(a.map(s=>S(e,s)))}}async function S(e,t){try{let n=d(t),a=await fetch(n,{cache:"no-store"});a.ok?await e.put(n,a.clone()):console.warn(`[SW] Failed to cache ${t}: ${a.status}`)}catch(n){console.warn(`[SW] Failed to cache ${t}:`,n)}}async function p(){try{let e=await fetch(h,{cache:"no-store"});return e.ok?e.json():null}catch(e){return console.error("[SW] Failed to fetch manifest:",e),null}}async function E(){try{let t=await(await caches.open(i)).match(h);return t?t.json():null}catch(e){return console.warn("[SW] Failed to get stored manifest:",e),null}}async function m(e){try{let t=await caches.open(i),n=new Response(JSON.stringify(e),{headers:{"Content-Type":"application/json"}});await t.put(h,n)}catch(t){console.error("[SW] Failed to store manifest:",t)}}async function v(e){if(!e?.files)return;let t=await caches.open(i),n=Object.keys(e.files);console.log(`[SW] Pre-caching ${n.length} files...`),await u(t,n),console.log("[SW] Pre-caching complete")}async function R(e,t){if(!t?.files)return;let n=await caches.open(i),a=e?.files||{},s=t.files,c=Object.keys(s).filter(r=>a[r]!==s[r]),f=Object.keys(a).filter(r=>!(r in s));console.log(`[SW] Updating: ${c.length} changed, ${f.length} deleted`),await Promise.all(f.map(r=>n.delete(d(r)))),await u(n,c),await m(t),c.length>0&&l({type:"CACHE_UPDATED",changedCount:c.length}),console.log("[SW] Cache update complete")}o.addEventListener("install",e=>{console.log("[SW] Installing..."),e.waitUntil((async()=>{let t=await p();t&&(await v(t),await m(t)),await o.skipWaiting()})())});o.addEventListener("activate",e=>{console.log("[SW] Activating..."),e.waitUntil((async()=>{let t=await caches.keys();await Promise.all(t.filter(n=>n!==i).map(n=>caches.delete(n))),await o.clients.claim()})())});o.addEventListener("fetch",e=>{let{request:t}=e;t.method!=="GET"||C(t.url)||e.respondWith(U(t))});async function U(e){let t=await caches.open(i),n=y(e.url),a=await t.match(n,{ignoreVary:!0});if(a)return a;try{let s=new URL(e.url);s.searchParams.set("_cb",String(Date.now()));let c=await fetch(s.toString(),{method:e.method,headers:e.headers,mode:"cors",credentials:e.credentials});return c.ok&&t.put(n,c.clone()),c}catch{if(e.mode==="navigate"){let s=await t.match(d("/"),{ignoreVary:!0});if(s)return s}return new Response("Offline",{status:503,statusText:"Service Unavailable"})}}o.addEventListener("message",e=>{let{type:t}=e.data||{};({SKIP_WAITING:()=>o.skipWaiting(),CLEAR_CACHE:()=>e.waitUntil((async()=>{await caches.delete(i),l({type:"CACHE_CLEARED"})})()),CHECK_FOR_UPDATES:()=>e.waitUntil((async()=>{console.log("[SW] Checking for updates...");let[a,s]=await Promise.all([E(),p()]);if(!s){console.log("[SW] Could not fetch new manifest");return}!a||a.version!==s.version?(console.log("[SW] New version detected, updating cache..."),await R(a,s)):console.log("[SW] No updates needed")})())})[t]?.()});
