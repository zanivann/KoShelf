var I=class{constructor(t){this.value=t}valueOf(){return this.value}},h=class extends I{constructor(t="???"){super(t)}toString(t){return`{${this.value}}`}},g=class extends I{constructor(t,e={}){super(t),this.opts=e}toString(t){try{return t.memoizeIntlObject(Intl.NumberFormat,this.opts).format(this.value)}catch(e){return t.reportError(e),this.value.toString(10)}}},w=class extends I{constructor(t,e={}){super(t),this.opts=e}toString(t){try{return t.memoizeIntlObject(Intl.DateTimeFormat,this.opts).format(this.value)}catch(e){return t.reportError(e),new Date(this.value).toISOString()}}};var it=100,St="\u2068",bt="\u2069";function wt(i,t,e){if(e===t||e instanceof g&&t instanceof g&&e.value===t.value)return!0;if(t instanceof g&&typeof e=="string"){let n=i.memoizeIntlObject(Intl.PluralRules,t.opts).select(t.value);if(e===n)return!0}return!1}function st(i,t,e){return t[e]?M(i,t[e].value):(i.reportError(new RangeError("No default")),new h)}function Z(i,t){let e=[],n=Object.create(null);for(let r of t)r.type==="narg"?n[r.name]=F(i,r.value):e.push(F(i,r));return{positional:e,named:n}}function F(i,t){switch(t.type){case"str":return t.value;case"num":return new g(t.value,{minimumFractionDigits:t.precision});case"var":return _t(i,t);case"mesg":return Tt(i,t);case"term":return Lt(i,t);case"func":return xt(i,t);case"select":return It(i,t);default:return new h}}function _t(i,{name:t}){let e;if(i.params)if(Object.prototype.hasOwnProperty.call(i.params,t))e=i.params[t];else return new h(`$${t}`);else if(i.args&&Object.prototype.hasOwnProperty.call(i.args,t))e=i.args[t];else return i.reportError(new ReferenceError(`Unknown variable: $${t}`)),new h(`$${t}`);if(e instanceof I)return e;switch(typeof e){case"string":return e;case"number":return new g(e);case"object":if(e instanceof Date)return new w(e.getTime());default:return i.reportError(new TypeError(`Variable type not supported: $${t}, ${typeof e}`)),new h(`$${t}`)}}function Tt(i,{name:t,attr:e}){let n=i.bundle._messages.get(t);if(!n)return i.reportError(new ReferenceError(`Unknown message: ${t}`)),new h(t);if(e){let r=n.attributes[e];return r?M(i,r):(i.reportError(new ReferenceError(`Unknown attribute: ${e}`)),new h(`${t}.${e}`))}return n.value?M(i,n.value):(i.reportError(new ReferenceError(`No value: ${t}`)),new h(t))}function Lt(i,{name:t,attr:e,args:n}){let r=`-${t}`,s=i.bundle._terms.get(r);if(!s)return i.reportError(new ReferenceError(`Unknown term: ${r}`)),new h(r);if(e){let l=s.attributes[e];if(l){i.params=Z(i,n).named;let d=M(i,l);return i.params=null,d}return i.reportError(new ReferenceError(`Unknown attribute: ${e}`)),new h(`${r}.${e}`)}i.params=Z(i,n).named;let o=M(i,s.value);return i.params=null,o}function xt(i,{name:t,args:e}){let n=i.bundle._functions[t];if(!n)return i.reportError(new ReferenceError(`Unknown function: ${t}()`)),new h(`${t}()`);if(typeof n!="function")return i.reportError(new TypeError(`Function ${t}() is not callable`)),new h(`${t}()`);try{let r=Z(i,e);return n(r.positional,r.named)}catch(r){return i.reportError(r),new h(`${t}()`)}}function It(i,{selector:t,variants:e,star:n}){let r=F(i,t);if(r instanceof h)return st(i,e,n);for(let s of e){let o=F(i,s.key);if(wt(i,r,o))return M(i,s.value)}return st(i,e,n)}function J(i,t){if(i.dirty.has(t))return i.reportError(new RangeError("Cyclic reference")),new h;i.dirty.add(t);let e=[],n=i.bundle._useIsolating&&t.length>1;for(let r of t){if(typeof r=="string"){e.push(i.bundle._transform(r));continue}if(i.placeables++,i.placeables>it)throw i.dirty.delete(t),new RangeError(`Too many placeables expanded: ${i.placeables}, max allowed is ${it}`);n&&e.push(St),e.push(F(i,r).toString(i)),n&&e.push(bt)}return i.dirty.delete(t),e.join("")}function M(i,t){return typeof t=="string"?i.bundle._transform(t):J(i,t)}var j=class{constructor(t,e,n){this.dirty=new WeakSet,this.params=null,this.placeables=0,this.bundle=t,this.errors=e,this.args=n}reportError(t){if(!this.errors||!(t instanceof Error))throw t;this.errors.push(t)}memoizeIntlObject(t,e){let n=this.bundle._intls.get(t);n||(n={},this.bundle._intls.set(t,n));let r=JSON.stringify(e);return n[r]||(n[r]=new t(this.bundle.locales,e)),n[r]}};function V(i,t){let e=Object.create(null);for(let[n,r]of Object.entries(i))t.includes(n)&&(e[n]=r.valueOf());return e}var at=["unitDisplay","currencyDisplay","useGrouping","minimumIntegerDigits","minimumFractionDigits","maximumFractionDigits","minimumSignificantDigits","maximumSignificantDigits"];function lt(i,t){let e=i[0];if(e instanceof h)return new h(`NUMBER(${e.valueOf()})`);if(e instanceof g)return new g(e.valueOf(),{...e.opts,...V(t,at)});if(e instanceof w)return new g(e.valueOf(),{...V(t,at)});throw new TypeError("Invalid argument to NUMBER")}var ot=["dateStyle","timeStyle","fractionalSecondDigits","dayPeriod","hour12","weekday","era","year","month","day","hour","minute","second","timeZoneName"];function ct(i,t){let e=i[0];if(e instanceof h)return new h(`DATETIME(${e.valueOf()})`);if(e instanceof w)return new w(e.valueOf(),{...e.opts,...V(t,ot)});if(e instanceof g)return new w(e.valueOf(),{...V(t,ot)});throw new TypeError("Invalid argument to DATETIME")}var dt=new Map;function ut(i){let t=Array.isArray(i)?i.join(" "):i,e=dt.get(t);return e===void 0&&(e=new Map,dt.set(t,e)),e}var R=class{constructor(t,{functions:e,useIsolating:n=!0,transform:r=s=>s}={}){this._terms=new Map,this._messages=new Map,this.locales=Array.isArray(t)?t:[t],this._functions={NUMBER:lt,DATETIME:ct,...e},this._useIsolating=n,this._transform=r,this._intls=ut(t)}hasMessage(t){return this._messages.has(t)}getMessage(t){return this._messages.get(t)}addResource(t,{allowOverrides:e=!1}={}){let n=[];for(let r=0;r<t.body.length;r++){let s=t.body[r];if(s.id.startsWith("-")){if(e===!1&&this._terms.has(s.id)){n.push(new Error(`Attempt to override an existing term: "${s.id}"`));continue}this._terms.set(s.id,s)}else{if(e===!1&&this._messages.has(s.id)){n.push(new Error(`Attempt to override an existing message: "${s.id}"`));continue}this._messages.set(s.id,s)}}return n}formatPattern(t,e=null,n=null){if(typeof t=="string")return this._transform(t);let r=new j(this,n,e);try{return J(r,t).toString(r)}catch(s){if(r.errors&&s instanceof Error)return r.errors.push(s),new h().toString(r);throw s}}};var Q=/^(-?[a-zA-Z][\w-]*) *= */gm,ht=/\.([a-zA-Z][\w-]*) *= */y,At=/\*?\[/y,tt=/(-?[0-9]+(?:\.([0-9]+))?)/y,Ot=/([a-zA-Z][\w-]*)/y,mt=/([$-])?([a-zA-Z][\w-]*)(?:\.([a-zA-Z][\w-]*))?/y,kt=/^[A-Z][A-Z0-9_-]*$/,U=/([^{}\n\r]+)/y,Ct=/([^\\"\n\r]*)/y,ft=/\\([\\"])/y,gt=/\\u([a-fA-F0-9]{4})|\\U([a-fA-F0-9]{6})/y,Dt=/^\n+/,pt=/ +$/,Mt=/ *\r?\n/g,Rt=/( *)$/,Pt=/{\s*/y,yt=/\s*}/y,$t=/\[\s*/y,Nt=/\s*] */y,Yt=/\s*\(\s*/y,Bt=/\s*->\s*/y,Ht=/\s*:\s*/y,Ft=/\s*,?\s*/y,Kt=/\s+/y,K=class{constructor(t){this.body=[],Q.lastIndex=0;let e=0;for(;;){let a=Q.exec(t);if(a===null)break;e=Q.lastIndex;try{this.body.push(d(a[1]))}catch(c){if(c instanceof SyntaxError)continue;throw c}}function n(a){return a.lastIndex=e,a.test(t)}function r(a,c){if(t[e]===a)return e++,!0;if(c)throw new c(`Expected ${a}`);return!1}function s(a,c){if(n(a))return e=a.lastIndex,!0;if(c)throw new c(`Expected ${a.toString()}`);return!1}function o(a){a.lastIndex=e;let c=a.exec(t);if(c===null)throw new SyntaxError(`Expected ${a.toString()}`);return e=a.lastIndex,c}function l(a){return o(a)[1]}function d(a){let c=m(),u=f();if(c===null&&Object.keys(u).length===0)throw new SyntaxError("Expected message value or attributes");return{id:a,value:c,attributes:u}}function f(){let a=Object.create(null);for(;n(ht);){let c=l(ht),u=m();if(u===null)throw new SyntaxError("Expected attribute value");a[c]=u}return a}function m(){let a;if(n(U)&&(a=l(U)),t[e]==="{"||t[e]==="}")return L(a?[a]:[],1/0);let c=E();return c?a?L([a,c],c.length):(c.value=H(c.value,Dt),L([c],c.length)):a?H(a,pt):null}function L(a=[],c){for(;;){if(n(U)){a.push(l(U));continue}if(t[e]==="{"){a.push(v());continue}if(t[e]==="}")throw new SyntaxError("Unbalanced closing brace");let b=E();if(b){a.push(b),c=Math.min(c,b.length);continue}break}let u=a.length-1,T=a[u];typeof T=="string"&&(a[u]=H(T,pt));let k=[];for(let b of a)b instanceof q&&(b=b.value.slice(0,b.value.length-c)),b&&k.push(b);return k}function v(){s(Pt,SyntaxError);let a=x();if(s(yt))return a;if(s(Bt)){let c=Y();return s(yt,SyntaxError),{type:"select",selector:a,...c}}throw new SyntaxError("Unclosed placeable")}function x(){if(t[e]==="{")return v();if(n(mt)){let[,a,c,u=null]=o(mt);if(a==="$")return{type:"var",name:c};if(s(Yt)){let T=$();if(a==="-")return{type:"term",name:c,attr:u,args:T};if(kt.test(c))return{type:"func",name:c,args:T};throw new SyntaxError("Function names must be all upper-case")}return a==="-"?{type:"term",name:c,attr:u,args:[]}:{type:"mesg",name:c,attr:u}}return O()}function $(){let a=[];for(;;){switch(t[e]){case")":return e++,a;case void 0:throw new SyntaxError("Unclosed argument list")}a.push(N()),s(Ft)}}function N(){let a=x();return a.type!=="mesg"?a:s(Ht)?{type:"narg",name:a.name,value:O()}:a}function Y(){let a=[],c=0,u;for(;n(At);){r("*")&&(u=c);let T=C(),k=m();if(k===null)throw new SyntaxError("Expected variant value");a[c++]={key:T,value:k}}if(c===0)return null;if(u===void 0)throw new SyntaxError("Expected default variant");return{variants:a,star:u}}function C(){s($t,SyntaxError);let a;return n(tt)?a=B():a={type:"str",value:l(Ot)},s(Nt,SyntaxError),a}function O(){if(n(tt))return B();if(t[e]==='"')return D();throw new SyntaxError("Invalid expression")}function B(){let[,a,c=""]=o(tt),u=c.length;return{type:"num",value:parseFloat(a),precision:u}}function D(){r('"',SyntaxError);let a="";for(;;){if(a+=l(Ct),t[e]==="\\"){a+=S();continue}if(r('"'))return{type:"str",value:a};throw new SyntaxError("Unclosed string literal")}}function S(){if(n(ft))return l(ft);if(n(gt)){let[,a,c]=o(gt),u=parseInt(a||c,16);return u<=55295||57344<=u?String.fromCodePoint(u):"\uFFFD"}throw new SyntaxError("Unknown escape sequence")}function E(){let a=e;switch(s(Kt),t[e]){case".":case"[":case"*":case"}":case void 0:return!1;case"{":return W(t.slice(a,e))}return t[e-1]===" "?W(t.slice(a,e)):!1}function H(a,c){return a.replace(c,"")}function W(a){let c=a.replace(Mt,`
`),u=Rt.exec(a)[1].length;return new q(c,u)}}},q=class{constructor(t,e){this.value=t,this.length=e}};var A=null,et=null;async function zt(){if(!A)try{let t=await(await fetch(`/assets/json/locales.json?t=${Date.now()}`)).json();A=new R(t.language);for(let e of t.resources){let n=new K(e);A.addResource(n)}}catch(i){console.warn("Failed to load translations:",i),A=new R("en-US")}}var y={async init(){et||(et=zt()),await et},get(i,t){if(!A)return i;let e;typeof t=="number"?e={count:t}:e=t;let n=i,r,s=i.indexOf(".");s!==-1&&(n=i.substring(0,s),r=i.substring(s+1));let o=A.getMessage(n);if(!o)return i;let l;return r?l=o.attributes?.[r]:l=o.value,l?A.formatPattern(l,e):i},getLanguage(){return A?.locales[0]||"en-US"}};var p=class{static get(t,e=null){try{let n=localStorage.getItem(this.PREFIX+t);return n===null?e:JSON.parse(n)}catch(n){return console.warn("StorageManager: Failed to parse item",n),e}}static set(t,e){try{localStorage.setItem(this.PREFIX+t,JSON.stringify(e))}catch(n){console.warn("StorageManager: Failed to save item",n)}}static remove(t){localStorage.removeItem(this.PREFIX+t)}};p.PREFIX="koshelf_",p.KEYS={RECAP_FILTER:"recap_filter",STATS_FILTER:"stats_filter",LIBRARY_LIST_BOOKS_FILTER:"library_list_books_filter",LIBRARY_LIST_COMICS_FILTER:"library_list_comics_filter",LIBRARY_LIST_BOOKS_SECTIONS:"library_list_books_sections",LIBRARY_LIST_COMICS_SECTIONS:"library_list_comics_sections",ITEM_DETAIL_BOOKS_SECTIONS:"item_detail_books_sections",ITEM_DETAIL_COMICS_SECTIONS:"item_detail_comics_sections",STATS_ALL_SECTIONS:"stats_all_sections",STATS_BOOKS_SECTIONS:"stats_books_sections",STATS_COMICS_SECTIONS:"stats_comics_sections",RECAP_SORT_NEWEST:"recap_sort_newest",VERSION:"version",SERVER_MODE:"server_mode",RELOAD_COUNT:"reload_count",LAST_RELOAD:"last_reload"};var G=class{constructor(){this.sections=new Map;this.persistenceKey=null;this.persistedState=null;this.init()}async init(){await y.init(),this.persistenceKey=this.resolvePersistenceKey(),this.persistedState=this.persistenceKey?p.get(this.persistenceKey,{})??{}:null,document.querySelectorAll("section[data-name]").forEach(e=>{let n=e.dataset.name;if(!n)return;let r=e.dataset.defaultVisible==="true",s=e.querySelector("button"),o=e.querySelector('[id$="Container"]'),l=s?.querySelector("svg"),d=s?.querySelector("span");s&&o&&l&&d&&(this.sections.set(n,{section:e,button:s,container:o,chevron:l,buttonText:d,defaultVisible:r}),this.setInitialState(n),s.addEventListener("click",()=>{this.toggle(n,{persist:!0})}))})}resolvePersistenceKey(){let t=document.body?.dataset.sectionToggleScope,e=document.body?.dataset.sectionToggleKind;return t==="library-list"?e==="comics"?p.KEYS.LIBRARY_LIST_COMICS_SECTIONS:e==="books"?p.KEYS.LIBRARY_LIST_BOOKS_SECTIONS:null:t==="item-details"?e==="comics"?p.KEYS.ITEM_DETAIL_COMICS_SECTIONS:e==="books"?p.KEYS.ITEM_DETAIL_BOOKS_SECTIONS:null:t==="statistics"?e==="books"?p.KEYS.STATS_BOOKS_SECTIONS:e==="comics"?p.KEYS.STATS_COMICS_SECTIONS:e==="all"?p.KEYS.STATS_ALL_SECTIONS:null:null}savePersistedState(){!this.persistenceKey||!this.persistedState||p.set(this.persistenceKey,this.persistedState)}setInitialState(t){let e=this.sections.get(t);if(!e)return;let{container:n,chevron:r,buttonText:s,defaultVisible:o}=e,l=this.persistedState&&Object.prototype.hasOwnProperty.call(this.persistedState,t)?this.persistedState[t]:null;(l===null?o:l)?(n.classList.remove("hidden"),r.style.transform="rotate(0deg)",s.textContent=y.get("toggle.hide")):(n.classList.add("hidden"),r.style.transform="rotate(-90deg)",s.textContent=y.get("toggle.show"))}toggle(t,e={}){let n=this.sections.get(t);if(!n)return;let{container:r}=n;r.classList.contains("hidden")?this.show(t,e):this.hide(t,e)}show(t,e={}){let n=this.sections.get(t);if(!n)return;let{container:r,chevron:s,buttonText:o}=n;r.classList.remove("hidden"),s.style.transform="rotate(0deg)",o.textContent=y.get("toggle.hide"),(e.persist??!0)&&this.persistedState&&(this.persistedState[t]=!0,this.savePersistedState())}hide(t,e={}){let n=this.sections.get(t);if(!n)return;let{container:r,chevron:s,buttonText:o}=n;r.classList.add("hidden"),s.style.transform="rotate(-90deg)",o.textContent=y.get("toggle.show"),(e.persist??!0)&&this.persistedState&&(this.persistedState[t]=!1,this.savePersistedState())}isVisible(t){let e=this.sections.get(t);return e?!e.container.classList.contains("hidden"):!1}showAll(){this.sections.forEach((t,e)=>{this.show(e)})}hideAll(){this.sections.forEach((t,e)=>{this.hide(e)})}getSectionNames(){return Array.from(this.sections.keys())}restorePersistedOrDefault(){this.sections.forEach((t,e)=>{let n=this.persistedState&&Object.prototype.hasOwnProperty.call(this.persistedState,e)?this.persistedState[e]:null;(n===null?t.defaultVisible:n)?this.show(e,{persist:!1}):this.hide(e,{persist:!1})})}};var _=class{static init(){this.tooltipElement||(this.tooltipElement=document.createElement("div"),this.tooltipElement.className="heatmap-tooltip hidden z-50 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 text-xs px-2 py-1 rounded shadow-lg pointer-events-none whitespace-normal break-words opacity-90 [--tooltip-color:theme(colors.gray.900)] dark:[--tooltip-color:theme(colors.gray.100)]",this.tooltipElement.setAttribute("role","tooltip"),this.tooltipContentElement=document.createElement("div"),this.tooltipContentElement.className="heatmap-tooltip__content max-w-xs",this.tooltipElement.appendChild(this.tooltipContentElement),document.body.appendChild(this.tooltipElement)),this.hasGlobalListeners||(this.hasGlobalListeners=!0,document.addEventListener("click",t=>{let e=t.target instanceof Node?t.target:null;this.activeCell&&e&&!this.activeCell.contains(e)&&this.hide()}),document.addEventListener("scroll",()=>{this.activeCell&&this.isVisible&&this.tooltipElement&&this.updatePosition(this.activeCell,this.tooltipElement)},{passive:!0,capture:!0}),window.addEventListener("resize",()=>{this.activeCell&&this.isVisible&&this.tooltipElement&&this.updatePosition(this.activeCell,this.tooltipElement)},{passive:!0}))}static attach(t,e){if(this.init(),t.dataset.tooltipContent=e,t.dataset.tooltipAttached==="1")return;t.dataset.tooltipAttached="1";let n=()=>{this.activeCell===t&&this.tooltipElement?.classList.contains("hidden");let r=t.dataset.tooltipContent||"";this.show(t,r)};t.addEventListener("mouseenter",()=>{n()}),t.addEventListener("mouseleave",()=>{this.hide()}),t.addEventListener("click",r=>{r.stopPropagation(),n()})}static show(t,e){this.tooltipElement&&(this.activeCell=t,this.tooltipContentElement?this.tooltipContentElement.textContent=e:this.tooltipElement.textContent=e,this.tooltipElement.classList.remove("hidden"),this.isVisible=!0,this.updatePosition(t,this.tooltipElement))}static hide(){this.tooltipElement&&(this.tooltipElement.classList.add("hidden"),this.isVisible=!1,this.tooltipElement.classList.remove("tooltip-top","tooltip-bottom","tooltip-left","tooltip-right")),this.activeCell&&(this.activeCell=null)}static updatePosition(t,e){if(!t.isConnected){this.hide();return}let n=t.getBoundingClientRect(),r=window.innerWidth,s=window.innerHeight,o=8,l=8,d=6;e.style.position="fixed",e.style.maxWidth=`${Math.max(0,r-o*2)}px`;let f=e.style.visibility;e.style.visibility="hidden",e.classList.remove("hidden"),e.style.top="0px",e.style.left="0px";let m=e.getBoundingClientRect();e.style.visibility=f;let L=n.left+n.width/2,v=n.top+n.height/2,x=n.top,$=s-n.bottom,N=n.left,Y=r-n.right,C=m.height+l+d,O=m.width+l+d,B=[{placement:"top",score:x>=C?1e4+x:x-C},{placement:"bottom",score:$>=C?1e4+$:$-C},{placement:"right",score:Y>=O?1e4+Y:Y-O},{placement:"left",score:N>=O?1e4+N:N-O}];B.sort((T,k)=>k.score-T.score);let D=B[0]?.placement??"top",S=0,E=0;D==="top"?(S=n.top-m.height-l-d,E=L-m.width/2):D==="bottom"?(S=n.bottom+l+d,E=L-m.width/2):D==="right"?(S=v-m.height/2,E=n.right+l+d):(S=v-m.height/2,E=n.left-m.width-l-d);let H=Math.max(o,r-m.width-o),W=Math.max(o,s-m.height-o);E=Math.min(Math.max(E,o),H),S=Math.min(Math.max(S,o),W);let a=d+6,c=Math.min(Math.max(L-E,a),Math.max(a,m.width-a)),u=Math.min(Math.max(v-S,a),Math.max(a,m.height-a));e.style.top=`${S}px`,e.style.left=`${E}px`,e.style.setProperty("--arrow-x",`${c}px`),e.style.setProperty("--arrow-y",`${u}px`),e.classList.remove("tooltip-top","tooltip-bottom","tooltip-left","tooltip-right"),e.classList.add(`tooltip-${D}`)}static cleanup(){this.tooltipElement&&(this.tooltipElement.remove(),this.tooltipElement=null,this.tooltipContentElement=null,this.isVisible=!1)}};_.tooltipElement=null,_.tooltipContentElement=null,_.activeCell=null,_.isVisible=!1,_.hasGlobalListeners=!1;var nt=class{constructor(){this.activityData=null;this.activityConfig=null;this.availableYears=[];this.currentYear=null;this.isInitialized=!1;this.resizeObserver=null;this.basePath="/assets/json/statistics"}async init(){if(!this.isInitialized)try{await y.init();let t=document.body.getAttribute("data-stats-json-base");t&&(this.basePath=t),this.getAvailableYearsFromTemplate(),this.initializeYearSelector(),this.availableYears.length>0&&(this.currentYear=this.availableYears[0],await this.loadYearData(this.currentYear),this.initializeHeatmap()),this.isInitialized=!0}catch(t){console.error("Error initializing heatmap:",t)}}getAvailableYearsFromTemplate(){let t=document.querySelectorAll(".year-option");this.availableYears=Array.from(t).map(e=>parseInt(e.getAttribute("data-year")||"0")).filter(e=>e>0)}async loadYearData(t){try{let e=await fetch(`${this.basePath}/daily_activity_${t}.json`);if(!e.ok)throw new Error(`Failed to load activity data for ${t}`);let n=await e.json();this.activityData=n.data,this.activityConfig=n.config,this.currentYear=t}catch(e){console.error(`Error loading activity data for ${t}:`,e),this.activityData=[],this.activityConfig={max_scale_seconds:null}}}initializeYearSelector(){let t=document.getElementById("yearSelectorWrapper"),e=document.getElementById("yearOptions");if(!t||!e)return;this.setupYearOptionHandlers();let n=document.querySelector(".year-option");n&&this.updateActiveYearOption(n),t.addEventListener("click",()=>{e.classList.toggle("hidden")})}setupYearOptionHandlers(){document.querySelectorAll(".year-option").forEach(e=>{e.addEventListener("click",async()=>{let n=parseInt(e.getAttribute("data-year")||"0");n>0&&(await this.selectYear(n),this.updateActiveYearOption(e),this.updateSelectedYearText(n),document.getElementById("yearOptions")?.classList.add("hidden"))})})}async selectYear(t){if(t!==this.currentYear)try{this.showLoadingState(),await this.loadYearData(t),this.initializeHeatmap()}catch(e){console.error(`Error selecting year ${t}:`,e)}finally{this.hideLoadingState()}}updateActiveYearOption(t){document.querySelectorAll(".year-option").forEach(n=>{n.classList.remove("bg-dark-700","text-white"),n.classList.add("text-dark-200")}),t.classList.add("bg-dark-700","text-white"),t.classList.remove("text-dark-200")}updateSelectedYearText(t){let e=document.getElementById("selectedYearText");e&&(e.innerHTML=`<span class="font-bold">${t}</span>`)}showLoadingState(){let t=document.getElementById("heatmapGrid");t&&(t.style.opacity="0.5")}hideLoadingState(){let t=document.getElementById("heatmapGrid");t&&(t.style.opacity="1")}initializeHeatmap(){if(!this.activityData||this.currentYear===null)return;this.setupHeightSync();let{activityMap:t,maxActivity:e}=this.processActivityData(this.activityData);this.fillHeatmapCells(t,e),this.currentYear===new Date().getFullYear()?this.scrollToCurrentMonth():this.scrollToEndOfYear(),this.setupResizeObserver()}setupHeightSync(){let t=document.getElementById("heatmapGrid"),e=document.getElementById("dayLabels");t&&e&&(e.style.height=t.offsetHeight+"px")}processActivityData(t){let e=new Map,n=0;return t.forEach(r=>{r.read_time>n&&(n=r.read_time),e.set(r.date,{pages:r.pages_read,read:r.read_time})}),this.activityConfig?.max_scale_seconds!==null&&this.activityConfig?.max_scale_seconds!==void 0&&(n=this.activityConfig.max_scale_seconds),{activityMap:e,maxActivity:n}}fillHeatmapCells(t,e){document.querySelectorAll(".activity-cell").forEach(r=>{if(this.currentYear===null)return;let s=this.calculateCellDate(r,this.currentYear),o=X.formatDateAsISO(s),l=t.get(o)||{pages:0,read:0},d=l.read,f=this.normalizeActivityLevel(d,e);this.applyCellStyling(r,f,o,l)})}calculateCellDate(t,e){let n=parseInt(t.getAttribute("data-week")||"0"),r=parseInt(t.getAttribute("data-day")||"0"),s=new Date(e,0,1),o=s.getDay(),l=o===0?-6:1-o,d=new Date(s);d.setDate(s.getDate()+l);let f=new Date(d);return f.setDate(f.getDate()+n*7+r),f}normalizeActivityLevel(t,e){let n=0;return t>0&&(e<=4?n=t:n=Math.min(4,Math.ceil(t/e*4))),n}applyCellStyling(t,e,n,r){let s=[["bg-gray-100","dark:bg-dark-800"],["bg-green-100","dark:bg-green-900"],["bg-green-300","dark:bg-green-700"],["bg-green-500","dark:bg-green-500"],["bg-green-600","dark:bg-green-300"]];s.flat().forEach(d=>t.classList.remove(d)),s[e].forEach(d=>t.classList.add(d));let o=X.formatDuration(r.read),l=`${n}: ${o}, ${r.pages} ${y.get("pages-label",r.pages)}`;_.attach(t,l),this.addCellHoverEffects(t)}addCellHoverEffects(t){t.addEventListener("mouseover",function(){this.classList.add("ring-1","ring-inset","ring-gray-900","dark:ring-white","z-10")}),t.addEventListener("mouseout",function(){this.classList.remove("ring-1","ring-inset","ring-gray-900","dark:ring-white","z-10")})}scrollToCurrentMonth(){let t=document.getElementById("heatmapScrollContainer"),e=document.getElementById("readingHeatmap");if(!t||!e)return;let n=new Date,r=this.calculateCurrentWeek(n),s=t.clientWidth,o=e.scrollWidth;if(o>s){let l=o/53,d=r*l-s*.7,f=o-s,m=Math.max(0,Math.min(d,f));t.scrollLeft=m}}scrollToEndOfYear(){let t=document.getElementById("heatmapScrollContainer"),e=document.getElementById("readingHeatmap");if(!t||!e)return;let n=t.clientWidth,r=e.scrollWidth;if(r>n){let s=r-n;t.scrollLeft=s*.8}}calculateCurrentWeek(t){let e=t.getFullYear(),n=new Date(e,0,1),r=n.getDay(),s=r===0?-6:1-r,o=new Date(n);o.setDate(n.getDate()+s);let l=Math.floor((t.getTime()-o.getTime())/(1e3*60*60*24));return Math.floor(l/7)}setupResizeObserver(){this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeObserver=new ResizeObserver(()=>{this.setupHeightSync()});let t=document.getElementById("heatmapGrid");t&&this.resizeObserver.observe(t)}destroy(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.isInitialized=!1,_.cleanup()}},X=class{static formatDateAsISO(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}static formatDuration(t){let e=Math.floor(t/3600),n=Math.floor(t%3600/60),r=[];return e&&r.push(`${e}h`),(n||!e)&&r.push(`${n}m`),r.join(" ")}},Et=new nt;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>Et.init()):Et.init();var rt=class{constructor(){this.loadingIndicator=null;this.weekStats=null;this.isInitialized=!1;this.statsJsonBasePath="/assets/json/statistics"}init(){if(this.isInitialized)return;this.loadingIndicator=document.getElementById("statsLoadingIndicator"),this.weekStats=document.querySelector(".week-stats");let t=document.body.getAttribute("data-stats-json-base");t&&(this.statsJsonBasePath=t),this.formatWeekDateDisplays(),this.initializeWeekSelector(),this.validateCurrentStreak(),this.isInitialized=!0}formatWeekDateDisplays(){let t=document.querySelectorAll(".week-option"),e=document.getElementById("selectedWeekText");if(t.forEach(n=>{let r=n.getAttribute("data-start-date"),s=n.getAttribute("data-end-date"),o=n.querySelector(".week-date-display");if(o&&r&&s){let l=z.formatDateRange(r,s);o.textContent=l}}),t.length>0&&e){let n=t[0],r=n.getAttribute("data-start-date"),s=n.getAttribute("data-end-date");if(r&&s){let o=r.substring(0,4),l=z.formatDateRange(r,s);e.innerHTML=`<span class="font-bold">${l}</span> <span class="text-primary-400">${o}</span>`}}}initializeWeekSelector(){let t=document.getElementById("weekSelectorWrapper"),e=document.getElementById("weekOptions"),n=document.querySelectorAll(".week-option"),r=document.getElementById("selectedWeekText");t&&e&&t.addEventListener("click",()=>{e.classList.toggle("hidden")}),n.forEach(s=>{s.addEventListener("click",()=>{let o=s.getAttribute("data-week-index"),l=s.getAttribute("data-start-date"),d=s.getAttribute("data-end-date");if(l&&d&&r){let f=l.substring(0,4),m=z.formatDateRange(l,d);r.innerHTML=`<span class="font-bold">${m}</span> <span class="text-primary-400">${f}</span>`}this.updateActiveOption(n,s),o&&this.loadWeekData(o),e?.classList.add("hidden")})}),n.length>0&&!n[0].classList.contains("bg-primary-50")&&(n[0].classList.add("bg-primary-50","dark:bg-dark-700","text-primary-900","dark:text-white"),n[0].classList.remove("text-gray-600","dark:text-dark-200"))}updateActiveOption(t,e){t.forEach(n=>{n.classList.remove("bg-primary-50","dark:bg-dark-700","text-primary-900","dark:text-white","bg-green-50","text-green-900"),n.classList.add("text-gray-600","dark:text-dark-200")}),e.closest("#weekOptions")?e.classList.add("bg-primary-50","dark:bg-dark-700","text-primary-900","dark:text-white"):e.classList.add("bg-green-50","dark:bg-dark-700","text-green-900","dark:text-white"),e.classList.remove("text-gray-600","dark:text-dark-200")}showLoadingIndicator(){this.loadingIndicator&&(this.loadingIndicator.classList.remove("hidden"),setTimeout(()=>{this.loadingIndicator?.classList.add("active")},10))}hideLoadingIndicator(){this.loadingIndicator&&(this.loadingIndicator.classList.remove("active"),setTimeout(()=>{this.loadingIndicator?.classList.add("hidden")},250))}async loadWeekData(t){try{this.weekStats&&(this.weekStats.classList.add("transition-out"),this.weekStats.classList.remove("transition-in")),this.showLoadingIndicator(),await new Promise(r=>setTimeout(r,200));let e=await fetch(`${this.statsJsonBasePath}/week_${t}.json`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);let n=await e.json();this.updateWeekStats(n),this.hideLoadingIndicator()}catch(e){console.error("Error loading week data:",e),this.hideLoadingIndicator(),this.weekStats&&(this.weekStats.classList.remove("transition-out"),this.weekStats.classList.add("transition-in"))}}updateWeekStats(t){let e=document.getElementById("weekReadTime"),n=document.getElementById("weekPagesRead"),r=document.getElementById("weekAvgPagesPerDay"),s=document.getElementById("weekAvgReadTimePerDay"),o=document.getElementById("weekLongestSession"),l=document.getElementById("weekAverageSession");e&&(e.textContent=P.formatReadTime(t.read_time)),n&&(n.textContent=String(t.pages_read)),r&&(r.textContent=P.formatAvgPages(t.avg_pages_per_day)),s&&(s.textContent=`${Math.floor(t.avg_read_time_per_day/60)}m`),o&&(o.textContent=P.formatReadTime(t.longest_session_duration)),l&&(l.textContent=P.formatReadTime(t.average_session_duration)),requestAnimationFrame(()=>{setTimeout(()=>{this.weekStats&&(this.weekStats.classList.remove("transition-out"),this.weekStats.classList.add("transition-in"))},50)})}validateCurrentStreak(){let t=document.getElementById("currentStreakDays"),e=document.getElementById("currentStreakDateRange"),n=document.getElementById("currentStreakDaysText");if(!t)return;let r=t.getAttribute("data-last-streak-date");if(!r)return;let s=new Date,o=s.getFullYear()+"-"+String(s.getMonth()+1).padStart(2,"0")+"-"+String(s.getDate()).padStart(2,"0");r!==o&&(t.textContent="0",n&&(n.textContent="days"),e&&(e.textContent=""))}},z=class{static parseISODate(t){try{return new Date(t)}catch{return console.error("Error parsing date:",t),new Date}}static formatDateNice(t){let e=["january","february","march","april","may","june","july","august","september","october","november","december"];return`${t.getDate()} ${y.get(e[t.getMonth()])}`}static formatDateRange(t,e){let n=this.parseISODate(t),r=this.parseISODate(e),s=n.getDate(),o=n.getMonth(),l=r.getDate(),d=r.getMonth(),f=n.getFullYear(),m=r.getFullYear(),v=["january.short","february.short","march.short","april.short","may.short","june.short","july.short","august.short","september.short","october.short","november.short","december.short"].map(x=>y.get(x));return o===d&&f===m?`${s}-${l} ${v[o]}`:`${s} ${v[o]} - ${l} ${v[d]}`}},P=class{static formatReadTime(t){if(t==null)return"--";let e=Math.floor(t/3600),n=Math.floor(t%3600/60);return e>0?`${e}h ${n}m`:`${n}m`}static formatAvgPages(t){return(Math.floor(t*10)/10).toFixed(1)}},Wt=new rt;async function vt(){await y.init(),new G,Wt.init()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>vt()):vt();export{P as DataFormatter,z as DateFormatter,rt as StatisticsManager,Wt as default};
